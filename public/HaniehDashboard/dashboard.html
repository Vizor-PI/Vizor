<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de modelos/lotes</title>

  <link rel="stylesheet" href="../assets/css/css-dashboard/dashboard.css" />
  <link rel="stylesheet" href="../assets/css/css-dashboard/navbar.css" />
  <link rel="icon" href="../assets/imgs/logosDash/home.png" type="image/x-icon" />

  <style>
    /* SEUS ESTILOS MANTIDOS */
    .container-xl { padding: 24px; max-width: 1400px; margin: auto; }
    h1, h2 { color: #00c8d2; font-weight: 600; margin-bottom: 12px; }
    header { background: #0f1f2b; border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 24px; }
    #date-filters { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    #date-filters label { font-size: 14px; opacity: .85; }
    #date-filters input[type="date"] { background: #0a141d; border: 1px solid rgba(255,255,255,0.2); padding: 6px 10px; border-radius: 8px; color: #fff; }
    #date-filters button { background: #00c8d2; border: none; padding: 8px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; color: #000; }
    #date-filters button:hover { filter: brightness(1.1); }
    
    .alert-top-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px; }
    #kpi-total, #kpi-critical, #kpi-top-model, #kpi-top-lote, #kpi-model-growth, #kpi-lote-growth { background:#0f1f2b; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:16px; min-height:110px; display:flex; flex-direction:column; justify-content:space-between; font-size:14px; font-weight:600; gap: 4px; }
    #kpi-total span, #kpi-critical span, #kpi-top-model span, #kpi-top-lote span, #kpi-model-growth span, #kpi-lote-growth span { display:block; font-size:28px; font-weight:700; margin-top:6px; }
    
    #charts canvas { background: #0f1f2b; padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); margin-bottom: 24px; }
    #charts label select { background:#0f1f2b; border:1px solid rgba(255,255,255,.15); color:#fff; border-radius:8px; padding:8px 10px; }
    

    
    #list-section { margin-top: 32px; }
    #list-section label select { background:#0f1f2b; border:1px solid rgba(255,255,255,.15); color:#fff; border-radius:8px; padding:6px 10px; }
    #listTable { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px; background:#0f1f2b; border-radius: 12px; overflow: hidden; border:1px solid rgba(255,255,255,.1); }
    #listTable th { background:#0a141d; padding: 10px; font-weight:600; border-bottom:1px solid rgba(255,255,255,.1); }
    #listTable td { padding: 10px; border-bottom:1px solid rgba(255,255,255,.05); }
    #listTable tr:hover { background: rgba(255,255,255,0.05); }
    
    .detailBtn { background:#00c8d2; border:none; padding:6px 10px; border-radius:6px; font-weight:600; cursor:pointer; color:#000; }
    
    /* Estilo do Modal Corrigido */
    .modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
    .modal-content { background:#0f1f2b; padding:20px; border-radius:10px; color:white; max-height:80%; overflow:auto; width:80%; position:relative; border:1px solid rgba(255,255,255,.2); }
    .close { position:absolute; right:20px; top:10px; font-size:24px; cursor:pointer; }
    
    #detailModal table { width:100%; margin-top:16px; border-collapse: collapse; }
    #detailModal th, #detailModal td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,.1); }

    @media(max-width:700px){
      #date-filters { flex-direction: column; align-items: flex-start; }
      #listTable { font-size: 12px; }
      .modal-content { width: 94%; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="verificarCargo()">
  <nav class="navbar" id="navbarConstructor"></nav>

  <div class="container-xl">

    <header>
        <h1>Comparação de Modelos/Lotes</h1>
        <div id="date-filters">
            <label>De: <input type="date" id="startDate" /></label>
            <label>Até: <input type="date" id="endDate" /></label>
            <!-- [CORREÇÃO] Adicionada função onclick -->
            <button id="applyRange">Aplicar</button> 
            <button id="presetWeek">Dados de Outubro</button> <!-- Renomeado para ficar claro -->
            <button id="presetMonth">Último mês</button>
        </div>
    </header>

    <section class="alert-top-grid">
        <div id="kpi-total">Total de alertas: <span id="kpi-total-val">—</span></div>
        <div id="kpi-critical">Alertas críticos: <span id="kpi-critical-val">—</span></div>
        <div id="kpi-top-model">Modelo com mais alertas: <span id="kpi-top-model-val">—</span></div>
        <div id="kpi-top-lote">Lote com mais alertas: <span id="kpi-top-lote-val">—</span></div>
        <div id="kpi-model-growth">Modelo com aumento crítico: <span id="kpi-model-growth-val">—</span></div>
        <div id="kpi-lote-growth">Lote com aumento crítico: <span id="kpi-lote-growth-val">—</span></div>
    </section>

    <section id="charts">
      <h2>Top 5 — Modelos (alertas críticos)</h2>
      <div>
        <label>De: <input type="date" id="barModelsStart"></label>
        <label>Até: <input type="date" id="barModelsEnd"></label>
        <button onclick="fetchTopBars()">Aplicar</button>
      </div>
      <canvas id="barModels"></canvas>

      <h2>Top 5 — Lotes (alertas críticos)</h2>
      <div>
        <label>De: <input type="date" id="barLotesStart"></label>
        <label>Até: <input type="date" id="barLotesEnd"></label>
        <button onclick="fetchTopBars()">Aplicar</button>
      </div>
      <canvas id="barLotes"></canvas>

      <h2>Comparação</h2>
      <div>
        <label>De: <input type="date" id="lineStart"></label>
        <label>Até: <input type="date" id="lineEnd"></label>
        <select id="compareEntityType">
          <option value="modelo">Modelo</option>
          <option value="lote">Lote</option>
        </select>
        <select id="compareEntity"></select>
        <button onclick="fetchComparison()">Aplicar</button>
      </div>
      <canvas id="lineComparison"></canvas>

      
    </section>

    <section id="list-section">
        <h2>Lista de modelos e lotes</h2>
        <label>Ver: <select id="viewSelect"><option value="both">Modelos + Lotes</option><option value="models">Modelos</option><option value="lotes">Lotes</option></select></label>
        <label>Estado: <select id="stateSelect"><option value="all">Todos</option><option value="critical">Crítico</option><option value="high">Alto</option><option value="medium">Médio</option><option value="low">Baixo</option></select></label>
        <label>Ordenar: <select id="orderSelect"><option value="desc">Mais → Menos</option><option value="asc">Menos → Mais</option></select></label>

        <table id="listTable" border="1">
            <thead>
                <tr><th>Tipo</th><th>Nome</th><th>Alertas (total)</th><th>Alertas críticos</th><th>Estado</th><th>Ações</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>


    <!-- Modal Único e Correto (Estilo gestao.css) -->
    <div id="detailModal" class="modal" style="display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
        <div class="modal-content" style="background:#0f1f2b; padding:20px; border-radius:10px; color:white; max-height:80%; overflow:auto; width:80%; position:relative;">
            <span id="closeDetail" class="close" style="position:absolute; right:20px; top:10px; font-size:24px; cursor:pointer;">&times;</span>
            <div id="detailContent"></div>
        </div>
    </div>
  </div> 
    
  <!-- Scripts -->
  <script src="../js/verificadorCargo.js"></script>
  <script src="../js/navbar.js"></script>

  <script>
        const apiBase = '/HaniehDash';
        let barModelsChart, barLotesChart, comparisonChart;

        async function populateCompareEntity() {
            const entityType = document.getElementById('compareEntityType').value;
            const userId = sessionStorage.ID_USUARIO;
            if (!userId) return;
            
            const res = await fetch(`/dadosModelos/listarModelosELotes/${userId}`);
            if (!res.ok) return;
            const data = await res.json();
            const select = document.getElementById('compareEntity');
            select.innerHTML = '';
            if (entityType === 'modelo') {
                [...new Set(data.map(d => d.modelo))].forEach(modelo => {
                    const opt = document.createElement('option');
                    opt.value = modelo;
                    opt.textContent = modelo;
                    select.appendChild(opt);
                });
            } else {
                [...new Set(data.map(d => d.lote))].forEach(lote => {
                    const opt = document.createElement('option');
                    opt.value = lote;
                    opt.textContent = lote;
                    select.appendChild(opt);
                });
            }
            if (select.options.length > 0) {
                select.selectedIndex = 0;
            }
            fetchComparison();
        }

        function initCharts() {
            const ctxM = document.getElementById('barModels').getContext('2d');
            barModelsChart = new Chart(ctxM, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Alertas críticos', data: [], backgroundColor: '#00c8d2' }] },
                options: { responsive: true }
            });

            // [CORREÇÃO] Removido listener duplicado
            document.getElementById('compareEntityType').addEventListener('change', populateCompareEntity);

            const ctxL = document.getElementById('barLotes').getContext('2d');
            barLotesChart = new Chart(ctxL, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Alertas críticos', data: [], backgroundColor: '#9b59b6' }] },
                options: { responsive: true }
            });

            const ctxPie = document.getElementById('lineComparison').getContext('2d');
            comparisonChart = new Chart(ctxPie, {
                type: 'pie',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#2ecc71', '#f1c40f', '#e74c3c'] }] },
                options: { responsive: true }
            });
        }

        function severityLabel(sev) {
            if (sev === "critico") return "Crítico";
            if (sev === "atencao") return "Atenção";
            if (sev === "normal") return "Normal";
            return sev || "—";
        }

        function setPresetWeek() {
            // [ATENÇÃO] Ajustado para pegar seus dados de OUTUBRO
            // Se quiser "hoje", mude para new Date()
            const today = new Date('2025-10-30'); // Força a data para Outubro para ver os dados
            const lastMonday = new Date(today);
            lastMonday.setDate(today.getDate() - 30); // Pega o mês inteiro
            
            const startStr = '2025-10-01';
            const endStr = '2025-10-31';

            const ids = [
                'startDate', 'endDate', // [CORREÇÃO] Adicionado os campos do header
                'barModelsStart', 'barModelsEnd',
                'barLotesStart', 'barLotesEnd',
                'lineStart', 'lineEnd'
            ];
            ids.forEach((id, i) => {
                const el = document.getElementById(id);
                if (el) el.value = (i % 2 === 0) ? startStr : endStr;
            });
        }

        function setPresetMonth() {
            const today = new Date();
            const lastMonthStart = new Date(today.getFullYear(), today.getMonth()-1, 1);
            const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
            document.getElementById('startDate').value = lastMonthStart.toISOString().slice(0,10);
            document.getElementById('endDate').value = lastMonthEnd.toISOString().slice(0,10);
        }

        async function fetchKpis() {
            const userId = sessionStorage.ID_USUARIO;
            if (!userId) { console.error('Usuário não autenticado!'); return; }
            
            // [CORREÇÃO] Pega os valores dos inputs de data do header
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            const q = new URLSearchParams({ userId, start, end });
            const res = await fetch(`${apiBase}/getKpis?${q}`);
            if (!res.ok) { console.error('Erro ao carregar KPIs'); return; }
            const data = await res.json();
            document.getElementById('kpi-total-val').textContent = data.totalAlerts ?? '—';
            document.getElementById('kpi-critical-val').textContent = data.criticoAlerts ?? '—';
            document.getElementById('kpi-top-model-val').textContent = data.topModel ? `${data.topModel.name} (${data.topModel.count})` : '—';
            document.getElementById('kpi-top-lote-val').textContent = data.topLote ? `${data.topLote.name} (${data.topLote.count})` : '—';
            document.getElementById('kpi-model-growth-val').textContent = data.modelGrowth ? `${data.modelGrowth.name} (${data.modelGrowth.pct}%)` : '';
            document.getElementById('kpi-lote-growth-val').textContent = data.loteGrowth ? `${data.loteGrowth.name} (${data.loteGrowth.pct}%)` : '';
        }

        async function fetchTopBars() {
            const startM = document.getElementById('barModelsStart').value;
            const endM = document.getElementById('barModelsEnd').value;
            const startL = document.getElementById('barLotesStart').value;
            const endL = document.getElementById('barLotesEnd').value;
            const userId = sessionStorage.ID_USUARIO;
            if (!userId) return;

            const qM = new URLSearchParams({ start: startM || '', end: endM || '', userId });
            const resM = await fetch(`${apiBase}/topModels?${qM}`);
            const qL = new URLSearchParams({ start: startL || '', end: endL || '', userId });
            const resL = await fetch(`${apiBase}/topLotes?${qL}`);

            if (!resM.ok || !resL.ok) return;
            const dataM = await resM.json();
            const dataL = await resL.json();
            
            barModelsChart.data.labels = dataM.map(x=>x.name);
            barModelsChart.data.datasets[0].data = dataM.map(x=>x.count);
            barModelsChart.update();
            
            barLotesChart.data.labels = dataL.map(x=>x.name);
            barLotesChart.data.datasets[0].data = dataL.map(x=>x.count);
            barLotesChart.update();
        }

        async function fetchComparison() {
            const start = document.getElementById('lineStart').value;
            const end = document.getElementById('lineEnd').value;
            const entityType = document.getElementById('compareEntityType').value;
            const entity = document.getElementById('compareEntity').value;
            const userId = sessionStorage.ID_USUARIO;
            
            if (!entity || !userId) return;
            
            const q = new URLSearchParams({ start: start||'', end: end||'', entityType, entity, userId });
            const res = await fetch(`${apiBase}/comparison?${q}`);
            if (!res.ok) return;
            const data = await res.json();
            comparisonChart.data.labels = data.labels;
            comparisonChart.data.datasets[0].data = data.datasets[0].data;
            comparisonChart.update();
        }

       
        

        async function fetchList() {
            const start = document.getElementById('barModelsStart').value;
            const end = document.getElementById('barModelsEnd').value;
            const view = document.getElementById('viewSelect').value;
            const state = document.getElementById('stateSelect').value;
            const order = document.getElementById('orderSelect').value;
            const userId = sessionStorage.ID_USUARIO;
            if (!userId) return;

            const q = new URLSearchParams({ start: start||'', end: end||'', view, state, order, userId });
            const res = await fetch(`${apiBase}/list?${q}`);
            if (!res.ok) return;
            const data = await res.json();
            renderList(data);
        }

        function renderList(items) {
            const tbody = document.querySelector('#listTable tbody');
            tbody.innerHTML = '';
            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.type}</td><td>${item.name}</td><td>${item.total}</td><td>${item.critico}</td><td>${severityLabel(item.state)}</td><td><button data-id='${item.type}|${item.id}' class='detailBtn'>Ver</button></td>`;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.detailBtn').forEach(b => b.addEventListener('click', (e) => {
                if(e.target.dataset.id) {
                    const [type,id] = e.target.dataset.id.split('|');
                    openDetails(type, id);
                }
            }));
        }

        async function fetchRecommendations() {
            const userId = sessionStorage.ID_USUARIO;
            if (!userId) return;
            const q = new URLSearchParams({ userId });
            const res = await fetch(`${apiBase}/recommend?${q}`);
            if (!res.ok) return;
            const data = await res.json();
            // Preenche divs ocultas se necessário
        }

        async function openDetails(type, id) {
            const userId = sessionStorage.ID_USUARIO;
            const res = await fetch(`${apiBase}/alerts/${type}/${id}?userId=${userId}`);
            if (!res.ok) return;
            const alerts = await res.json();
            const content = document.getElementById('detailContent');
            content.innerHTML = `<h3>Detalhes — ${type} ${id}</h3>`;
            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th>Data</th><th>Tipo</th><th>Valor</th><th>Severidade</th></tr></thead>`;
            const tbody = document.createElement('tbody');
            alerts.slice(0,50).forEach(a => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${a.timestamp}</td><td>${a.type}</td><td>${a.valor}</td><td>${a.severidade}</td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            content.appendChild(table);
            document.getElementById('detailModal').style.display = 'flex';
        }

        document.getElementById('viewSelect').addEventListener('change', fetchList);
        document.getElementById('stateSelect').addEventListener('change', fetchList);
        document.getElementById('orderSelect').addEventListener('change', fetchList);
        document.getElementById('closeDetail').addEventListener('click', () => { document.getElementById('detailModal').style.display = 'none'; });

        // [CORREÇÃO] Adicionada a ação ao botão Aplicar do header
        const btnApply = document.getElementById('applyRange');
        if(btnApply) {
            btnApply.addEventListener('click', () => {
                refreshAll();
            });
        }

        async function refreshAll() {
            await Promise.all([ fetchKpis(), fetchTopBars(), fetchComparison(), fetchList(), fetchRecommendations() ]);
        }

        // --- INICIALIZAÇÃO SEGURA ---
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            
            document.getElementById('compareEntityType').addEventListener('change', () => { populateCompareEntity(); });
            document.getElementById('compareEntity').addEventListener('change', fetchComparison);
            document.getElementById('lineStart').addEventListener('change', fetchComparison);
            document.getElementById('lineEnd').addEventListener('change', fetchComparison);
            
            // Verificação de segurança para o botão presetWeek
            const presetBtn = document.getElementById('presetWeek');
            if(presetBtn) {
                presetBtn.onclick = () => { setPresetWeek(); refreshAll(); };
            }
            const presetMonth = document.getElementById('presetMonth');
            if(presetMonth) {
                presetMonth.onclick = () => { setPresetMonth(); refreshAll(); };
            }
            
            // Delay para garantir session
            setTimeout(() => {
                populateCompareEntity(); // Carrega o select de comparação
                setPresetWeek();
                refreshAll();
            }, 500); 
        });
    </script>

    <script>
        function limparSessao() { sessionStorage.clear(); }
    </script>
</body>
</html>
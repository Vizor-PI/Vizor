<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de modelos/lotes</title>

  <link rel="stylesheet" href="../assets/css/css-dashboard/dashboard.css" />
  <link rel="stylesheet" href="../assets/css/css-dashboard/navbar.css" />
  <link rel="icon" href="../assets/imgs/logosDash/home.png" type="image/x-icon" />

  <style>
    
    .alert-top-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:16px;
      margin-bottom:16px;
    }

    .alert-kpi{
      background:#0f1f2b; /* alinhado ao card geral escuro/azulado */
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:12px 16px;
      min-height:110px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      color:#fff;
    }

    .alert-kpi .head{
      font-size:14px;
      line-height:1.3;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
      color:#fff;
    }

    .alert-kpi .sev-dot{
      width:10px;
      height:10px;
      border-radius:999px;
    }
    .sev-dot.critico{
      background:#e74c3c;
      box-shadow:0 0 10px #e74c3c55;
    }
    .sev-dot.alerta{
      background:#f39c12;
      box-shadow:0 0 10px #f39c1255;
    }
    .sev-dot.info{
      background:#3498db;
      box-shadow:0 0 10px #3498db55;
    }

    .alert-kpi .value{
      font-size:28px;
      font-weight:700;
      line-height:1.2;
      color:#fff;
    }

    .alert-kpi .desc{
      font-size:12px;
      line-height:1.4;
      opacity:.75;
      color:#fff;
    }

    /* header e filtro */
    .alerts-header{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      margin-bottom:16px;
      color:#fff;
    }
    .alerts-header-left h2{
      margin:0;
      color:#00c8d2; /* título teal/azul claro como os títulos da dash */
      font-weight:600;
    }
    .alerts-header-left small{
      font-size:12px;
      opacity:.7;
      line-height:1.4;
      display:block;
      margin-top:4px;
      color:#fff;
    }

    .alerts-header-right{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-end;
    }

    .filter-group{
      display:flex;
      flex-direction:column;
      gap:4px;
      color:#fff;
    }
    .filter-group label{
      font-size:12px;
      opacity:.8;
      color:#fff;
    }

    /* sobrescrevendo ui-select dentro desse contexto
       só pra garantir contraste azul escuro + borda leve,
       imitando selects da outra tela  */
    .alerts-header-right .ui-select{
      background:#0f1f2b;
      border:1px solid rgba(255,255,255,.15);
      color:#fff;
      border-radius:8px;
      padding:8px 10px;
      min-width:140px;
    }

    /* lista de alertas (feed) */
    .alert-list{
      display:flex;
      flex-direction:column;
      gap:12px;
      color:#fff;
    }

    /* cada alerta vira um "mini-card" com mesma vibe de card da dash */
    .alert-card{
      background:#0f1f2b;
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:12px 16px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:12px;
      color:#fff;
    }

    .alert-main{
      font-size:13px;
      line-height:1.4;
      color:#fff;
    }

    .alert-headline{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:6px;
      color:#fff;
    }

    .alert-title{
      font-size:14px;
      font-weight:600;
      line-height:1.4;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      color:#fff;
    }

    .alert-status-badge{
      font-size:11px;
      font-weight:600;
      border-radius:999px;
      padding:2px 8px;
      line-height:1.3;
      display:inline-block;
      white-space:nowrap;
    }
    .alert-status-badge.critico{
      background:#ffe6e6;
      color:#a40000;
    }
    .alert-status-badge.alerta{
      background:#fff8e6;
      color:#a66300;
    }
    .alert-status-badge.info{
      background:#e6f1ff;
      color:#004a99;
    }

    .alert-time{
      opacity:.7;
      font-size:12px;
      color:#fff;
    }

    .alert-subinfo{
      font-size:12px;
      opacity:.9;
      line-height:1.4;
      color:#fff;
    }

    .alert-meta-grid{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      font-size:12px;
      opacity:.8;
      line-height:1.4;
      color:#fff;
    }

    .alert-aside{
      min-width:150px;
      font-size:12px;
      line-height:1.4;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      text-align:right;
      color:#fff;
    }

    .alert-action{
      margin-top:8px;
      font-size:12px;
      line-height:1.4;
      text-align:right;
      opacity:.9;
      color:#fff;
    }
    .alert-action strong{
      display:block;
      font-size:12px;
      font-weight:600;
      margin-bottom:2px;
      color:#fff;
    }

    @media(max-width:700px){
      .alert-card{
        grid-template-columns:1fr;
        text-align:left;
      }
      .alert-aside{
        text-align:left;
      }
      .alert-action{
        text-align:left;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="verificarCargo()">
  <nav class="navbar" id="navbarConstructor"></nav>

  <div class="container-xl">

    <header>
        <h1>Dashboard de Alertas (Monitoração)</h1>
        <div id="date-filters">
            <label>De: <input type="date" id="startDate" /></label>
            <label>Até: <input type="date" id="endDate" /></label>
            <button id="applyRange">Aplicar</button>
            <button id="presetWeek">Semana passada</button>
            <button id="presetMonth">Último mês</button>
        </div>
    </header>

    <section class="alert-top-grid">
        <div id="kpi-total">Total de alertas: <span id="kpi-total-val">—</span></div>
        <div id="kpi-critical">Alertas críticos: <span id="kpi-critical-val">—</span></div>
        <div id="kpi-top-model">Modelo com mais alertas: <span id="kpi-top-model-val">—</span></div>
        <div id="kpi-top-lote">Lote com mais alertas: <span id="kpi-top-lote-val">—</span></div>
        <div id="kpi-model-growth">Modelo com aumento crítico: <span id="kpi-model-growth-val">—</span></div>
        <div id="kpi-lote-growth">Lote com aumento crítico: <span id="kpi-lote-growth-val">—</span></div>
    </section>

    <section id="charts">
        <h2>Top 5 — Modelos (alertas críticos)</h2>
        <canvas id="barModels" width="600" height="200"></canvas>


        <h2>Top 5 — Lotes (alertas críticos)</h2>
        <canvas id="barLotes" width="600" height="200"></canvas>


        <h2>Comparação</h2>
        <label>Tipo de alerta:
            <select id="alertTypeSelect">
                <option value="all">Todos</option>
                <option value="typeA">ok</option>
                <option value="typeB">médio</option>
                <option value="typeC">crítico</option>
            </select>
        </label>
        <canvas id="lineComparison" width="900" height="250"></canvas>


        <h2>Mapa de calor — alertas críticos (semana padrão)</h2>
        <div id="heatmapContainer">(o heatmap será desenhado em tabela)</div>
    </section>

    <section id="list-section">
        <h2>Lista de modelos e lotes</h2>
        <label>Ver: <select id="viewSelect"><option value="both">Modelos + Lotes</option><option value="models">Modelos</option><option value="lotes">Lotes</option></select></label>
        <label>Estado: <select id="stateSelect"><option value="all">Todos</option><option value="critical">Crítico</option><option value="high">Alto</option><option value="medium">Médio</option><option value="low">Baixo</option></select></label>
        <label>Ordenar: <select id="orderSelect"><option value="desc">Mais → Menos</option><option value="asc">Menos → Mais</option></select></label>


        <table id="listTable" border="1">
            <thead>
                <tr><th>Tipo</th><th>Nome</th><th>Alertas (total)</th><th>Alertas críticos</th><th>Estado</th><th>Ações</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>
      </div>
    
  

  <script src="../js/verificadorCargo.js"></script>
  <script src="../js/navbar.js"></script>

  <script>
  (function(){
    // mock de alertas recentes
    const mockAlerts = [
      {
        hostname: "DOOH-SP-P03",
        severidade: "info",
        titulo: "Player reiniciado com sucesso",
        detalhe: "Reboot remoto concluído.",
        cpu: 18,
        temp: 50,
        ram: 41,
        uptime_h: 0.4,
        ping: "agora mesmo",
        abertoHa: "3 min",
        acao_recomendada: "Monitorar estabilidade pós reboot.",
        tipo_acao: "Monitoramento"
      },
      {
        hostname: "DOOH-SP-P11",
        severidade: "critico",
        titulo: "Sem ping há 5 min",
        detalhe: "Possível queda de rede ou travamento hard.",
        cpu: 0,
        temp: 64,
        ram: 40,
        uptime_h: 8,
        ping: "sem resposta",
        abertoHa: "5 min",
        acao_recomendada: "Checar alimentação / link 4G.",
        tipo_acao: "Visita técnica"
      },
      {
        hostname: "DOOH-SP-P01",
        severidade: "critico",
        titulo: "Temperatura acima de 85ºC",
        detalhe: "CPU em 92% + 87ºC há 14 minutos",
        cpu: 92,
        temp: 87,
        ram: 78,
        uptime_h: 26,
        ping: "há 40 s",
        abertoHa: "14 min",
        acao_recomendada: "Verificar ventilação / bloqueio de airflow.",
        tipo_acao: "Intervenção física"
      },
      {
        hostname: "DOOH-SP-P05",
        severidade: "info",
        titulo: "Atualização de software aplicada",
        detalhe: "Build 1.0.37 instalada.",
        cpu: 29,
        temp: 59,
        ram: 47,
        uptime_h: 3,
        ping: "há 30 s",
        abertoHa: "28 min",
        acao_recomendada: "Verificar se exibidor voltou a rodar playlist.",
        tipo_acao: "Verificação visual"
      },
      {
        hostname: "DOOH-SP-P04",
        severidade: "alerta",
        titulo: "Cpu acima de 75%",
        detalhe: "Processos acumulando RAM.",
        cpu: 79,
        temp: 72,
        ram: 83,
        uptime_h: 30,
        ping: "há 1 min",
        abertoHa: "2 h",
        acao_recomendada: "Reinicialização remota sugerida.",
        tipo_acao: "Ação remota"
      },
      {
        hostname: "DOOH-SP-P07",
        severidade: "alerta",
        titulo: "Uptime contínuo acima de 48h",
        detalhe: "Processos acumulando RAM.",
        cpu: 64,
        temp: 75,
        ram: 86,
        uptime_h: 53,
        ping: "há 1 min",
        abertoHa: "2 h",
        acao_recomendada: "Reinicialização remota sugerida.",
        tipo_acao: "Ação remota"
      },
      {
        hostname: "DOOH-SP-P10",
        severidade: "alerta",
        titulo: "CPU acima de 75%",
        detalhe: "Processos acumulando RAM.",
        cpu: 77,
        temp: 72,
        ram: 83,
        uptime_h: 42,
        ping: "há 1 min",
        abertoHa: "2 h",
        acao_recomendada: "Acompanhamento.",
        tipo_acao: "Ação remota"
      },
      {
        hostname: "DOOH-SP-P06",
        severidade: "critico",
        titulo: "Uptime contínuo acima de 72h",
        detalhe: "Processos acumulando RAM.",
        cpu: 68,
        temp: 75,
        ram: 84,
        uptime_h: 72,
        ping: "há 1 min",
        abertoHa: "2 h",
        acao_recomendada: "Reinicialização remota sugerida.",
        tipo_acao: "Ação remota"
      }
    ];

    /* ========= KPIs superiores ========= */
    function atualizarKPIs(alerts){
      const crit = alerts.filter(a=>a.severidade==="critico").length;
      const alrt = alerts.filter(a=>a.severidade==="alerta").length;
      const info = alerts.filter(a=>a.severidade==="info").length;

      document.getElementById("kpi-criticos").textContent = crit;
      document.getElementById("kpi-alertas").textContent = alrt;
      document.getElementById("kpi-info").textContent = info;
    }

    /* ========= Filtros ========= */
    const filtroSev = document.getElementById("filtro-severidade");
    const filtroHorario = document.getElementById("filtro-horario");

    filtroSev.addEventListener("change", renderLista);
    filtroHorario.addEventListener("change", renderLista);

    function passaFiltroTempo(alert, janela){
      if (janela === "todas") return true; // "Últimas 24h" -> tudo do mock

      const txt = alert.abertoHa; // "14 min", "2 h", ...
      if (!txt) return true;

      if (janela === "1h"){
        // só eventos abaixo de 60 min
        if (txt.includes("min")){
          const n = parseInt(txt);
          return !Number.isNaN(n) && n < 60;
        }
        if (txt.includes("h")){
          const n = parseInt(txt);
          return !Number.isNaN(n) && n < 1;
        }
        return false;
      }

      if (janela === "7d"){
        // mock não tem dias, então tudo que é hora ou min passa
        return true;
      }

      return true;
    }

    /* ========= Render da lista ========= */
    function renderLista(){
      const alvo = document.getElementById("alert-list");
      alvo.innerHTML = "";

      const sevSelecionada = filtroSev.value;        
      const tempoSelecionado = filtroHorario.value;  

      const parseMin = (txt)=>{
        if (!txt) return Infinity;
        if (txt.includes("min")){
          const n = parseInt(txt);
          return Number.isNaN(n)?Infinity:n;
        }
        if (txt.includes("h")){
          const n = parseInt(txt);
          return Number.isNaN(n)?Infinity:n*60;
        }
        return Infinity;
      };

      const finalList = mockAlerts
        .filter(a=>{
          return (sevSelecionada==="todos" || a.severidade===sevSelecionada)
              && passaFiltroTempo(a, tempoSelecionado);
        })
        .sort((a,b)=> parseMin(a.abertoHa) - parseMin(b.abertoHa)); 

      finalList.forEach(a=>{
        const card = document.createElement("div");
        card.className = "alert-card";

        card.innerHTML = `
          <div class="alert-main">
            <div class="alert-headline">
              <div class="alert-title">
                <span>${a.hostname}</span>
                <span class="alert-status-badge ${a.severidade}">${a.severidade.toUpperCase()}</span>
              </div>
              <div class="alert-time">Aberto há ${a.abertoHa}</div>
            </div>

            <div class="alert-subinfo">
              <strong>${a.titulo}</strong><br/>
              ${a.detalhe}
            </div>

            <div class="alert-meta-grid">
              <span>CPU ${a.cpu}%</span>
              <span>Temp ${a.temp}ºC</span>
              <span>RAM ${a.ram}%</span>
              <span>Uptime ${a.uptime_h}h</span>
              <span>Ping ${a.ping}</span>
            </div>
          </div>

          <aside class="alert-aside">
            <div class="alert-action">
              <strong>${a.tipo_acao}</strong>
              ${a.acao_recomendada}
            </div>
          </aside>
        `;

        alvo.appendChild(card);
      });

      if (finalList.length === 0){
        const empty = document.createElement("div");
        empty.style.fontSize = "13px";
        empty.style.opacity = "0.7";
        empty.style.color = "#fff";
        empty.textContent = "Nenhum aviso neste filtro.";
        alvo.appendChild(empty);
      }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      verificarCargo();
      atualizarKPIs(mockAlerts);
      renderLista();
    });
  })();
  </script>

  <script>
    function limparSessao() {
      sessionStorage.clear();
    }
  </script>
</body>
</html>

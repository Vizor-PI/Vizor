<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vizor | Dashboard de Incidentes ITIL</title>

  <!-- 
     ___________________________________________________________________________________
     IMPORTAÇÃO DE ESTILOS E BIBLIOTECAS
     ___________________________________________________________________________________
  -->
  <link rel="stylesheet" href="../assets/css/css-dashboard/dashboard.css" />
  <link rel="stylesheet" href="../assets/css/css-dashboard/navbar.css" />
  <link rel="icon" href="../assets/imgs/logosDash/home.png" type="image/x-icon" />

  <!-- Leaflet CSS (Para o Mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <!-- Chart.js (Para os Gráficos) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ___________________________________________________________________________________
       ESTILOS GERAIS E LAYOUT
       Definição do Grid principal e correções de posicionamento.
       ___________________________________________________________________________________
    */
    
    /* ======== ESTILO BASE ======== */
    body {
      background-color: #061722;
      color: white;
      font-family: 'Akatab', sans-serif;
      margin: 0;
      padding: 0;
      /* [CORREÇÃO] Flexbox para layout lateral robusto (Navbar na esquerda, Conteúdo na direita) */
      display: flex; 
      flex-direction: row;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* [CORREÇÃO CRÍTICA DA NAVBAR] 
       Força a navbar a se comportar como uma coluna flexível e fixa, 
       independentemente do que o CSS externo diga. */
    .navbar {
        position: sticky !important; /* Fica fixa ao rolar a página */
        top: 0;
        height: 100vh !important;    /* Ocupa a altura total da tela */
        flex-shrink: 0;              /* Impede que a navbar encolha se o conteúdo for grande */
        z-index: 999;                /* Garante que fique por cima de outros elementos */
        /* Se o navbar.css original não tiver width, definimos um padrão */
        min-width: 250px;            
        display: flex;
        flex-direction: column;
    }

    /* Header Principal com Botão */
    .main-header {
        display: flex;
        justify-content: center; 
        align-items: center;
        position: relative;
        margin: 30px 0;
    }
    
    .main-header h1 {
        color: aqua;
        margin: 0;
        text-align: center;
    }

    .header-actions {
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
    }

    /* Container Principal (Onde fica o conteúdo da dashboard) */
    .container-xl { 
      flex-grow: 1; 
      padding: 24px; 
      box-sizing: border-box;
      width: 100%; /* Garante que ocupe o espaço restante */
      max-width: calc(100vw - 250px); /* Evita overflow horizontal */
      overflow-y: auto;
    }

    /* ___________________________________________________________________________________
       COMPONENTES VISUAIS (KPIs, Cards, Alertas)
       ___________________________________________________________________________________
    */

    /* ======== KPIs GERAIS (JIRA) ======== */
    .kpi-card {
      background: #072135;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .kpi-row-4 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .kpi-label { color: aqua; font-weight: 600; margin-bottom: 4px; }
    .kpi-value { font-size: 32px; font-weight: 800; }
    .kpi-sub { opacity: 0.8; font-size: 13px; }

    /* ======== CARDS PADRÃO ======== */
    .card {
      background-color: #072135;
      border-radius: 16px;
      color: white;
      padding: 16px;
      box-sizing: border-box;
      margin-bottom: 24px;
    }
    .card-header { margin-bottom: 12px; }
    .card-title { color: aqua; font-weight: 700; font-size: 1.4rem; }

    /* ======== ALERTAS: KPIs SUPERIORES ======== */
    .alert-top-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .alert-kpi {
      background: #0f1f2b;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 12px 16px;
      min-height: 110px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: #fff;
    }
    .alert-kpi .head {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* Bolinhas indicadoras de severidade */
    .sev-dot { width: 10px; height: 10px; border-radius: 999px; }
    .sev-dot.critico { background: #e74c3c; box-shadow: 0 0 10px #e74c3c55; }
    .sev-dot.alerta { background: #f39c12; box-shadow: 0 0 10px #f39c1255; }
    .sev-dot.info { background: #3498db; box-shadow: 0 0 10px #3498db55; }
    
    .alert-kpi .value { font-size: 28px; font-weight: 700; line-height: 1.2; }
    .alert-kpi .desc { font-size: 12px; opacity: .75; }

    /* ======== ALERTAS: FILTROS E HEADER ======== */
    .alerts-header {
      display: flex; flex-wrap: wrap; justify-content: space-between;
      align-items: flex-start; gap: 16px; margin-bottom: 16px;
    }
    .alerts-header-right { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 12px; opacity: .8; }
    .ui-select {
      background: #0f1f2b; border: 1px solid rgba(255,255,255,.15);
      color: #fff; border-radius: 8px; padding: 8px 10px; min-width: 140px;
    }

    /* ======== ALERTAS: LISTA DE CARDS ======== */
    .alert-list { display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
    
    /* Customização da Scrollbar */
    .alert-list::-webkit-scrollbar { width: 6px; }
    .alert-list::-webkit-scrollbar-track { background: #0e1117; }
    .alert-list::-webkit-scrollbar-thumb { background: #00bcd4; border-radius: 4px; }

    .alert-card {
      background: #0f1f2b;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 12px 16px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      color: #fff;
      transition: transform 0.2s;
    }
    .alert-card:hover { transform: translateX(4px); border-color: rgba(255,255,255,.2); }

    .alert-main { font-size: 13px; line-height: 1.4; }
    .alert-headline { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
    
    .alert-title { font-size: 14px; font-weight: 600; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    
    .alert-status-badge {
      font-size: 11px; font-weight: 600; border-radius: 999px; padding: 2px 8px;
      display: inline-block; white-space: nowrap; text-transform: uppercase;
    }
    .alert-status-badge.critico { background: #ffe6e6; color: #a40000; }
    .alert-status-badge.alerta { background: #fff8e6; color: #a66300; }
    .alert-status-badge.info { background: #e6f1ff; color: #004a99; }

    .alert-time { opacity: .7; font-size: 12px; }
    .alert-subinfo { font-size: 12px; opacity: .9; margin-bottom: 8px; }
    
    .alert-meta-grid {
      margin-top: 8px; display: flex; flex-wrap: wrap; gap: 12px;
      font-size: 12px; opacity: .8; background: rgba(0,0,0,0.2);
      padding: 6px; border-radius: 6px;
    }

    .alert-aside {
      min-width: 140px; font-size: 12px; display: flex;
      flex-direction: column; justify-content: center; text-align: right;
    }
    .alert-action { margin-top: 8px; color: aqua; font-weight: 600; }

    /* ======== GRÁFICOS E MAPAS ======== */
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .chart-box { height: 350px; }
    #vizor-map { width: 100%; height: 420px; border-radius: 12px; }

    /* ======== BOTÕES ======== */
    .vizor-btn {
        background: #00bcd4; 
        color: #000; 
        border: none; 
        padding: 8px 16px; 
        border-radius: 4px; 
        cursor: pointer; 
        font-weight: bold;
        transition: background 0.3s;
    }
    .vizor-btn:hover { background: #00acc1; }

    /* ======== MODAL ======== */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 1000; display: none;
        justify-content: center; align-items: center;
    }
    .modal-content {
        background: #072135; padding: 24px; border-radius: 12px;
        border: 1px solid #00bcd4; width: 90%; max-width: 600px;
        color: white;
    }

    /* Responsividade Mobile */
    @media(max-width:700px){
      body { flex-direction: column; }
      .navbar { height: auto !important; position: relative !important; width: 100%; }
      .container-xl { max-width: 100%; }
      .alert-card { grid-template-columns: 1fr; text-align: left; }
      .alert-aside { text-align: left; justify-content: flex-start; margin-top: 8px; }
      .main-header { flex-direction: column; gap: 16px; }
      .header-actions { position: static; transform: none; }
    }
  </style>
</head>

<body>
    <!-- 
       ___________________________________________________________________________________
       NAVBAR
       ___________________________________________________________________________________
    -->
    <nav class="navbar">
      <!-- Logo -->
      <a href="#">
        <img src="../assets/imgs/logosDash/logoDashboard.png" alt="" class="imagemLogoDashboard">
      </a>

      <!-- Menu -->
      <ul id="textosNavbar">
      <li class="nav-item active">
        <img src="../assets/imgs/logosDash/dashboardIcon.png" alt="" id="logoNavbarDash">
        <a href="dashboardIncidentes.html"> Incidentes </a>
      </li>
    
      <li class="nav-item" id="adm-only" style="display: none;">
        <img src="../assets/imgs/logosDash/logoGestao.png" alt="" id="logoNavbarDash">
        <a href="gestaoUsuarios.html"> Contas </a>
      </li><li class="nav-item">
        <img src="../assets/imgs/logosDash/mudarContaIcon.png" alt="" id="logoNavbarDash">
        <a href="alterarDados.html"> Alterar dados </a>
      </li>
      <li class="nav-item" id="adm-only2" style="display: none;">
        <img src="../assets/imgs/logosDash/configIcon.png" alt="" id="logoNavbarDash">
        <a href="infoConta.html"> Info. da conta </a>
      </li>
    </ul>

      <!-- Botão Sair -->
      <div id="divSair">
        <img src="../assets/imgs/logosDash/exitIcon.png" id="logoNavbarDash">
        <a href="../index.html" onclick="limparSessao()"> Sair </a>
      </div>
 </nav>

 <main class="container-xl">
    
    <!-- HEADER PRINCIPAL COM BOTÃO DE RELATÓRIO -->
    <div class="main-header">
        <h1>Dashboard de Incidentes - ITIL</h1>
        <div class="header-actions">
            <button id="btn-open-report" class="vizor-btn">Gerar Relatório</button>
        </div>
    </div>

    <!-- 
       ___________________________________________________________________________________
       SEÇÃO 1: KPIs GERAIS (JIRA)
       Mostra os números consolidados de incidentes e SLA.
       ___________________________________________________________________________________
    -->
    <section class="card kpi-card">
      <header class="card-header">
        <h2 class="card-title">Status Geral dos Chamados (Jira)</h2>
      </header>
      
      <div class="vizor-filter" style="padding-left: 22px; padding-top: 10px;">
        <label for="periodo" style="font-size: 0.9rem; color: #ccc;">Período:</label>
        <select id="periodo" class="vizor-select" style="background:#0e1117; color:white; border:1px solid #00bcd4; border-radius:6px; padding:4px 8px;">
          <option value="24h">Últimas 24h</option>
          <option value="7d" selected>Última semana</option>
          <option value="30d">Último mês</option>
        </select>
      </div>

      <div class="card-content">
        <div class="kpi-row-4">
          <div><h4 class="kpi-label">Abertos</h4><p class="kpi-value" id="kpi-incidentes-abertos">--</p><p class="kpi-sub">Em andamento</p></div>
          <div><h4 class="kpi-label">Fechados</h4><p class="kpi-value" id="kpi-incidentes-fechados">--</p><p class="kpi-sub">Total resolvido</p></div>
          <div><h4 class="kpi-label">Tempo médio</h4><p class="kpi-value" id="kpi-tempo-resolucao">--</p><p class="kpi-sub">para resolução</p></div>
          <div><h4 class="kpi-label">SLA Cumprido</h4><p class="kpi-value" id="kpi-sla">--</p><p class="kpi-sub">No prazo</p></div>
        </div>
      </div>
    </section>

    <!-- 
       ___________________________________________________________________________________
       SEÇÃO 2: ALERTAS DE HARDWARE (TEMPO REAL - S3)
       ___________________________________________________________________________________
    -->
    <section class="alert-top-grid">
      <div class="alert-kpi">
        <div class="head"><span class="sev-dot critico"></span><span>Alertas Críticos</span></div>
        <div class="value" id="kpi-criticos">0</div>
        <div class="desc">Falhas graves de hardware/rede.</div>
      </div>
      <div class="alert-kpi">
        <div class="head"><span class="sev-dot alerta"></span><span>Em Atenção</span></div>
        <div class="value" id="kpi-alertas">0</div>
        <div class="desc">Sobrecarga ou aquecimento.</div>
      </div>
      <div class="alert-kpi">
        <div class="head"><span class="sev-dot info"></span><span>Infos</span></div>
        <div class="value" id="kpi-infos">0</div>
        <div class="desc">Monitoramento regular.</div>
      </div>
    </section>

    <!-- Lista de Cards com Filtros -->
    <section class="card">
        <div class="alerts-header">
          <div class="alerts-header-left">
            <h2 class="card-title">Alertas de Hardware (Tempo Real)</h2>
            <small>Dados processados via AWS Lambda (Trusted -> Client)</small>
          </div>
          <div class="alerts-header-right">
            <div class="filter-group">
              <label for="filtro-severidade">Severidade</label>
              <select id="filtro-severidade" class="ui-select">
                <option value="todos" selected>Todos</option>
                <option value="CRITICO">Crítico</option>
                <option value="ALERTA">Alerta</option>
                <option value="INFO">Info</option>
              </select>
            </div>
          </div>
        </div>

        <div class="alert-list" id="alert-list">
          <p style="text-align: center; color: #888; padding: 20px;">Carregando avisos do S3 Client...</p>
        </div>
    </section>

    <!-- 
       ___________________________________________________________________________________
       SEÇÃO 3: GRÁFICOS (CHART.JS)
       Visualizações de tendências e categorias.
       ___________________________________________________________________________________
    -->
    <section class="grid-2">
      <div class="card">
        <header class="card-header"><h2 class="card-title">Incidentes por Área</h2></header>
        <div class="card-content"><div class="chart-box"><canvas id="chartIncidentesArea"></canvas></div></div>
      </div>
      <div class="card">
        <header class="card-header"><h2 class="card-title">Tendência Semanal</h2></header>
        <div class="card-content"><div class="chart-box"><canvas id="chartTendenciaIncidentes"></canvas></div></div>
      </div>
    </section>

    <!-- 
       ___________________________________________________________________________________
       SEÇÃO 4: MAPA DE CALOR (LEAFLET)
       Distribuição geográfica dos incidentes.
       ___________________________________________________________________________________
    -->
    <section class="card" style="padding:16px; margin-bottom:16px;">
      <header class="card-header"><h2 class="card-title">Mapa de Calor</h2><small style="opacity:.7;">Distribuição geográfica</small></header>
      <div id="vizor-map"></div>
    </section>

    <!-- 
       ___________________________________________________________________________________
       SEÇÃO 5: MODAL DE RELATÓRIO (PDF)
       Configuração e geração de relatório para impressão.
       ___________________________________________________________________________________
    -->
    <div id="modal-relatorio" class="modal-overlay">
        <div class="modal-content">
            <!-- Passo 1: Seletor de Filtros -->
            <div id="step-selector">
                <h2 style="margin-top:0; color:aqua;">Configurar Relatório</h2>
                
                <div style="margin-bottom: 16px;">
                    <label class="vizor-label">Período:</label><br>
                    <div style="margin-top: 8px; display: flex; gap: 15px;">
                        <label class="vizor-radio"><input type="radio" name="report-type" value="semanal" checked> Semanal</label>
                        <label class="vizor-radio"><input type="radio" name="report-type" value="mensal"> Mensal</label>
                        <label class="vizor-radio"><input type="radio" name="report-type" value="trimestral"> Trimestral</label>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label class="vizor-label">Filtrar por Máquina:</label><br>
                    <select id="filtro-maquina-rel" class="ui-select" style="width: 100%; margin-top:8px;">
                        <option value="todas">Todas as Máquinas</option>
                        <!-- Populated via JS -->
                    </select>
                </div>

                <div style="display:flex; justify-content: flex-end; gap: 10px;">
                    <button id="btn-cancel-report" class="vizor-btn" style="background:#171a20; border:1px solid #555;">Cancelar</button>
                    <button id="btn-generate-report" class="vizor-btn">Gerar Relatório</button>
                </div>
            </div>

            <!-- Passo 2: Relatório Gerado (Card para Impressão) -->
            <div id="step-result" style="display: none;">
                <div id="printable-area" style="background: #072135; padding: 20px; border-radius: 8px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">
                        <div>
                            <h3 style="margin:0; color:aqua;">Relatório de Incidentes</h3>
                            <small id="report-date-display" style="color:#ccc;">Emissão: 26/11/2025</small>
                        </div>
                    </div>

                    <div class="kpi-row-4" style="margin-bottom: 20px;">
                        <div style="text-align:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                            <div style="font-size:0.8rem; opacity:0.8">Abertos</div>
                            <div id="rel-kpi-abertos" style="font-size:1.4rem; font-weight:bold;">-</div>
                        </div>
                        <div style="text-align:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                            <div style="font-size:0.8rem; opacity:0.8">Fechados</div>
                            <div id="rel-kpi-fechados" style="font-size:1.4rem; font-weight:bold;">-</div>
                        </div>
                        <div style="text-align:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                            <div style="font-size:0.8rem; opacity:0.8">Tempo Médio</div>
                            <div id="rel-kpi-tempo" style="font-size:1.4rem; font-weight:bold;">-</div>
                        </div>
                        <div style="text-align:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                            <div style="font-size:0.8rem; opacity:0.8">SLA</div>
                            <div id="rel-kpi-sla" style="font-size:1.4rem; font-weight:bold;">-</div>
                        </div>
                    </div>

                    <p style="font-size: 0.9rem; color: #aaa;">* Dados extraídos do Jira Service Management.</p>
                </div>

                <div style="display:flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button id="btn-back-report" class="vizor-btn" style="background:#171a20; border:1px solid #555;">Voltar</button>
                    <button id="btn-print-report" class="vizor-btn" style="background:#2fbf71;">Baixar PDF</button>
                </div>
            </div>
        </div>
    </div>

 </main>

  <!-- SCRIPTS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // URL da API Node.js (Backend)
    const API_BASE_URL = "http://localhost:3333/api/jira"; 
    
    // Variáveis globais de estado
    let globalAvisos = []; 
    let map; 
    let markersLayer = new L.LayerGroup(); 
    
    // Cache de dados para uso no Relatório (Modal)
    let dadosKpiCache = { aberto: 0, fechado: 0, tempoMedio: 0, sla: 0 };
    let listaMaquinasCache = new Set(); 

    // Inicialização da página
    document.addEventListener("DOMContentLoaded", () => {
      inicializarMapa(); 
      atualizarKPIsJira();
      processarAvisos();
      gerarGraficos(); 
    });

    /* ___________________________________________________________________________________
       FUNÇÕES DO MAPA (LEAFLET)
       Inicialização e plotagem de marcadores dinâmicos.
       ___________________________________________________________________________________
    */
    function inicializarMapa() {
      // Cria o mapa focado em São Paulo
      map = L.map('vizor-map').setView([-23.5614, -46.6559], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
        attribution: '&copy; OpenStreetMap' 
      }).addTo(map);
      // Adiciona camada de marcadores (para poder limpar depois)
      markersLayer.addTo(map);
    }
    
    function renderizarMapa() {
      markersLayer.clearLayers(); // Limpa marcadores antigos
      
      globalAvisos.forEach(aviso => {
        // Verifica se o JSON possui Lat/Long válidas
        if (aviso.raw_metrics.latitude && aviso.raw_metrics.longitude) {
            const lat = aviso.raw_metrics.latitude;
            const long = aviso.raw_metrics.longitude;
            const severidade = aviso.ui.severity;
            const mensagem = aviso.ui.message;

            // Define cor baseada na severidade
            let corCirculo = '#3498db'; 
            let raio = 8; 

            if (severidade === "CRITICO") {
                corCirculo = '#e74c3c'; // Vermelho
                raio = 14; 
            } else if (severidade === "ALERTA") {
                corCirculo = '#f39c12'; // Amarelo
                raio = 11;
            }
            
            const marcador = L.circleMarker([lat, long], {
                radius: raio,
                fillColor: corCirculo,
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            // Popup com detalhes
            const popupContent = `
                <div style="color:black;">
                    <strong>Máquina ID:</strong> ${aviso.machine_id}<br>
                    <strong>Situação:</strong> <span style="font-weight:bold; color: ${corCirculo};">${severidade}</span><br>
                    <strong>Problema:</strong> ${mensagem}<br>
                    <strong>Temp/CPU/Disco:</strong> ${aviso.raw_metrics.temp}°C / ${aviso.raw_metrics.cpu}% / ${aviso.raw_metrics.disco}%
                </div>
            `;
            marcador.bindPopup(popupContent);
            markersLayer.addLayer(marcador);
        }
      });
      
      // Ajusta o zoom para mostrar todos os pontos
      if (markersLayer.getLayers().length > 0) {
           try { map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] }); } catch(e) {}
      }
    }

    /* ___________________________________________________________________________________
       FUNÇÕES DO JIRA (KPIs)
       Busca dados do backend para preencher os cards de topo.
       ___________________________________________________________________________________
    */
    async function atualizarKPIsJira() {
      try {
        const response = await fetch(`${API_BASE_URL}/metricas`);
        const dados = await response.json();
        dadosKpiCache = dados; // Armazena para o relatório

        document.getElementById("kpi-incidentes-abertos").textContent = dados.aberto;
        document.getElementById("kpi-incidentes-fechados").textContent = dados.fechado;
        document.getElementById("kpi-tempo-resolucao").textContent = dados.tempoMedio + "h";
        document.getElementById("kpi-sla").textContent = dados.sla + "%";
      } catch (err) { console.error("Erro KPIs Jira", err); }
    }

    /* ___________________________________________________________________________________
       FUNÇÕES DE ALERTAS (S3)
       Busca JSONs do S3, calcula contagens e renderiza a lista de cards.
       ___________________________________________________________________________________
    */
    async function processarAvisos() {
      try {
        const response = await fetch(`${API_BASE_URL}/avisos`);
        globalAvisos = await response.json();
        
        // Coleta IDs para o filtro do relatório
        globalAvisos.forEach(aviso => listaMaquinasCache.add(aviso.machine_id));
        popularSelectMaquinas();

        // Conta totais por severidade
        const criticos = globalAvisos.filter(a => a.ui.severity === "CRITICO").length;
        const alertas = globalAvisos.filter(a => a.ui.severity === "ALERTA").length;
        const infos = globalAvisos.filter(a => a.ui.severity === "INFO").length;

        document.getElementById("kpi-criticos").textContent = criticos;
        document.getElementById("kpi-alertas").textContent = alertas;
        document.getElementById("kpi-infos").textContent = infos;

        renderizarListaAvisos();
        renderizarMapa(); 
      } catch (err) {
        console.error("Erro Avisos S3", err);
        document.getElementById("alert-list").innerHTML = "<p>Erro ao carregar.</p>";
      }
    }

    function popularSelectMaquinas() {
        const select = document.getElementById("filtro-maquina-rel");
        select.innerHTML = '<option value="todas">Todas as Máquinas</option>';
        listaMaquinasCache.forEach(id => {
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = id;
            select.appendChild(opt);
        });
    }

    function renderizarListaAvisos() {
        const container = document.getElementById("alert-list");
        container.innerHTML = "";
        const filtroSev = document.getElementById("filtro-severidade").value;
        
        // Filtra a lista global
        const filtrados = globalAvisos.filter(a => {
            return filtroSev === "todos" || a.ui.severity === filtroSev;
        });

        if (filtrados.length === 0) {
            container.innerHTML = "<p style='text-align:center; opacity:0.7; padding:20px;'>Nenhum aviso encontrado.</p>";
            return;
        }

        // Cria o HTML de cada card
        filtrados.forEach(aviso => {
            let sevClass = "info";
            if (aviso.ui.severity === "CRITICO") sevClass = "critico";
            if (aviso.ui.severity === "ALERTA") sevClass = "alerta";

            const card = document.createElement("div");
            card.className = "alert-card";
            card.innerHTML = `
                <div class="alert-main">
                    <div class="alert-headline">
                        <div class="alert-title">
                            <span>${aviso.machine_id}</span>
                            <span class="alert-status-badge ${sevClass}">${aviso.ui.severity}</span>
                        </div>
                        <div class="alert-time">${aviso.last_update}</div>
                    </div>
                    <div class="alert-subinfo">
                        <strong>${aviso.ui.title}</strong><br/>
                        ${aviso.ui.message}
                    </div>
                    <div class="alert-meta-grid">
                        <span>CPU ${aviso.raw_metrics.cpu}</span>
                        <span>Temp ${aviso.raw_metrics.temp}</span>
                        <span>RAM ${aviso.raw_metrics.ram}</span>
                        <span>Disco ${aviso.raw_metrics.disco}</span>
                    </div>
                </div>
                <aside class="alert-aside">
                    <div class="alert-action">
                        <strong>Ação:</strong>
                        ${aviso.ui.action}
                    </div>
                </aside>
            `;
            container.appendChild(card);
        });
    }
    document.getElementById("filtro-severidade").addEventListener("change", renderizarListaAvisos);

    /* ___________________________________________________________________________________
       FUNÇÕES DE GRÁFICOS (CHART.JS)
       Gera os gráficos de barras (Áreas) e linha (Tendência).
       ___________________________________________________________________________________
    */
    async function gerarGraficos() {
      try {
        const resposta = await fetch(`${API_BASE_URL}/issues`);
        const listaChamados = await resposta.json();

        // Contagem para o gráfico de áreas (Labels)
        let totalInfra = 0; let totalApps = 0; let totalRede = 0; let totalSeguranca = 0; let totalBanco = 0;

        listaChamados.forEach(chamado => {
            if (chamado.fields && chamado.fields.labels && chamado.fields.labels.length > 0) {
                const etiquetas = chamado.fields.labels;
                if (etiquetas.includes("infraestrutura")) totalInfra++;
                else if (etiquetas.includes("aplicacoes")) totalApps++;
                else if (etiquetas.includes("rede")) totalRede++;
                else if (etiquetas.includes("seguranca")) totalSeguranca++;
                else if (etiquetas.includes("banco_de_dados")) totalBanco++;
                else totalInfra++;
            } else { totalInfra++; }
        });

        const ctxArea = document.getElementById('chartIncidentesArea').getContext('2d');
        new Chart(ctxArea, {
          type: 'bar',
          data: {
            labels: ['Infraestrutura', 'Aplicações', 'Rede', 'Segurança', 'Banco de Dados'],
            datasets: [{
              label: 'Quantidade de Incidentes',
              data: [totalInfra, totalApps, totalRede, totalSeguranca, totalBanco],
              backgroundColor: 'rgba(10, 203, 227, 0.6)',
              borderColor: 'rgba(10, 203, 227, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } } },
            plugins: { legend: { display: false } }
          }
        });

        // Contagem para o gráfico de tendência (Semanal)
        let contagemSemanal = [0, 0, 0, 0, 0, 0, 0]; 
        const hoje = new Date();
        const seteDiasAtras = new Date();
        seteDiasAtras.setDate(hoje.getDate() - 7);

        listaChamados.forEach(chamado => {
            if (chamado.fields && chamado.fields.created) {
                const dataCriacao = new Date(chamado.fields.created);
                if (dataCriacao >= seteDiasAtras) {
                    const diaDaSemana = dataCriacao.getDay(); 
                    contagemSemanal[diaDaSemana]++;
                }
            }
        });

        const ctxTrend = document.getElementById('chartTendenciaIncidentes').getContext('2d');
        new Chart(ctxTrend, {
          type: 'line',
          data: {
            labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
            datasets: [{
              label: 'Novos Incidentes (Últimos 7 dias)',
              data: contagemSemanal,
              borderColor: '#ff5c5c',
              backgroundColor: 'rgba(255, 92, 92, 0.2)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { beginAtZero: true, ticks: { stepSize: 1, color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } } },
            plugins: { legend: { labels: { color: '#fff' } } }
          }
        });
      } catch (erro) { console.error("Erro ao gerar gráficos:", erro); }
    }

    /* ___________________________________________________________________________________
       FUNÇÕES DE RELATÓRIO (MODAL & PDF)
       ___________________________________________________________________________________
    */
    const modal = document.getElementById("modal-relatorio");
    const stepSelector = document.getElementById("step-selector");
    const stepResult = document.getElementById("step-result");

    // Abrir Modal
    document.getElementById("btn-open-report").onclick = () => {
        modal.style.display = "flex";
        stepSelector.style.display = "block";
        stepResult.style.display = "none";
    };

    // Cancelar/Fechar
    const fecharModal = () => { modal.style.display = "none"; };
    document.getElementById("btn-cancel-report").onclick = fecharModal;
    document.getElementById("btn-close-report").onclick = fecharModal;
    
    // Voltar
    document.getElementById("btn-back-report").onclick = () => {
        stepSelector.style.display = "block";
        stepResult.style.display = "none";
    };

    // Gerar Relatório (Preencher dados)
    document.getElementById("btn-generate-report").onclick = () => {
        document.getElementById("rel-kpi-abertos").textContent = dadosKpiCache.aberto;
        document.getElementById("rel-kpi-fechados").textContent = dadosKpiCache.fechado;
        document.getElementById("rel-kpi-tempo").textContent = dadosKpiCache.tempoMedio + "h";
        document.getElementById("rel-kpi-sla").textContent = dadosKpiCache.sla + "%";
        document.getElementById("report-date-display").textContent = "Emissão: " + new Date().toLocaleDateString("pt-BR");

        stepSelector.style.display = "none";
        stepResult.style.display = "block";
    };

    // Download do PDF
    document.getElementById("btn-print-report").onclick = async () => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const element = document.getElementById("printable-area");
        
        const canvas = await html2canvas(element, { scale: 2, backgroundColor: "#072135" });
        const imgData = canvas.toDataURL("image/png");
        
        pdf.text("Relatório de Incidentes - Vizor", 10, 15);
        pdf.addImage(imgData, "PNG", 10, 25, 190, 0);
        pdf.save("Relatorio_Vizor.pdf");
    };

    function limparSessao() { sessionStorage.clear(); }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vizor | Dashboard de Incidentes ITIL</title>

  <link rel="stylesheet" href="../assets/css/css-dashboard/dashboard.css" />
  <link rel="stylesheet" href="../assets/css/css-dashboard/navbar.css" />
  <link rel="icon" href="../assets/imgs/logosDash/home.png" type="image/x-icon" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ======== ESTILO BASE ======== */
    body {
      background-color: #061722;
      color: white;
      font-family: 'Akatab', sans-serif;
      margin: 0;
      padding: 0;
      /* Ajuste para layout lateral (Navbar + Conteúdo) */
      display: flex; 
      min-height: 100vh;
    }

    h1 { color: aqua; text-align: center; margin: 30px 0; }
    
    .container-xl { 
      /* Ajuste para ocupar o espaço restante ao lado da navbar */
      flex-grow: 1; 
      padding: 24px; 
      box-sizing: border-box;
      width: auto; /* Reseta largura fixa que poderia quebrar o flex */
      overflow-x: hidden;
    }

    /* ======== KPIs GERAIS (JIRA) ======== */
    .kpi-card {
      background: #072135;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .kpi-row-4 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .kpi-label { color: aqua; font-weight: 600; margin-bottom: 4px; }
    .kpi-value { font-size: 32px; font-weight: 800; }
    .kpi-sub { opacity: 0.8; font-size: 13px; }

    /* ======== CARDS PADRÃO ======== */
    .card {
      background-color: #072135;
      border-radius: 16px;
      color: white;
      padding: 16px;
      box-sizing: border-box;
      margin-bottom: 24px;
    }
    .card-header { margin-bottom: 12px; }
    .card-title { color: aqua; font-weight: 700; font-size: 1.4rem; }

    /* ======== ALERTAS: KPIs SUPERIORES (Estilo novo) ======== */
    .alert-top-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .alert-kpi {
      background: #0f1f2b;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 12px 16px;
      min-height: 110px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: #fff;
    }
    .alert-kpi .head {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sev-dot { width: 10px; height: 10px; border-radius: 999px; }
    .sev-dot.critico { background: #e74c3c; box-shadow: 0 0 10px #e74c3c55; }
    .sev-dot.alerta { background: #f39c12; box-shadow: 0 0 10px #f39c1255; }
    .sev-dot.info { background: #3498db; box-shadow: 0 0 10px #3498db55; }
    
    .alert-kpi .value { font-size: 28px; font-weight: 700; line-height: 1.2; }
    .alert-kpi .desc { font-size: 12px; opacity: .75; }

    /* ======== ALERTAS: FILTROS E HEADER ======== */
    .alerts-header {
      display: flex; flex-wrap: wrap; justify-content: space-between;
      align-items: flex-start; gap: 16px; margin-bottom: 16px;
    }
    .alerts-header-right { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 12px; opacity: .8; }
    .ui-select {
      background: #0f1f2b; border: 1px solid rgba(255,255,255,.15);
      color: #fff; border-radius: 8px; padding: 8px 10px; min-width: 140px;
    }

    /* ======== ALERTAS: LISTA DE CARDS ======== */
    .alert-list { display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
    
    /* Scrollbar personalizada para a lista */
    .alert-list::-webkit-scrollbar { width: 6px; }
    .alert-list::-webkit-scrollbar-track { background: #0e1117; }
    .alert-list::-webkit-scrollbar-thumb { background: #00bcd4; border-radius: 4px; }

    .alert-card {
      background: #0f1f2b;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 12px 16px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      color: #fff;
      transition: transform 0.2s;
    }
    .alert-card:hover { transform: translateX(4px); border-color: rgba(255,255,255,.2); }

    .alert-main { font-size: 13px; line-height: 1.4; }
    .alert-headline { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
    
    .alert-title { font-size: 14px; font-weight: 600; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    
    .alert-status-badge {
      font-size: 11px; font-weight: 600; border-radius: 999px; padding: 2px 8px;
      display: inline-block; white-space: nowrap; text-transform: uppercase;
    }
    .alert-status-badge.critico { background: #ffe6e6; color: #a40000; }
    .alert-status-badge.alerta { background: #fff8e6; color: #a66300; }
    .alert-status-badge.info { background: #e6f1ff; color: #004a99; }

    .alert-time { opacity: .7; font-size: 12px; }
    .alert-subinfo { font-size: 12px; opacity: .9; margin-bottom: 8px; }
    
    .alert-meta-grid {
      margin-top: 8px; display: flex; flex-wrap: wrap; gap: 12px;
      font-size: 12px; opacity: .8; background: rgba(0,0,0,0.2);
      padding: 6px; border-radius: 6px;
    }

    .alert-aside {
      min-width: 140px; font-size: 12px; display: flex;
      flex-direction: column; justify-content: center; text-align: right;
    }
    .alert-action { margin-top: 8px; color: aqua; font-weight: 600; }

    /* ======== GRÁFICOS E MAPAS ======== */
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .chart-box { height: 350px; }
    #vizor-map { width: 100%; height: 420px; border-radius: 12px; }

    @media(max-width:700px){
      .alert-card { grid-template-columns: 1fr; text-align: left; }
      .alert-aside { text-align: left; justify-content: flex-start; margin-top: 8px; }
    }
  </style>
</head>

<body>
    <!-- NAVBAR ORIGINAL RESTAURADA -->
    <nav class="navbar">
      <!-- Logo -->
      <a href="#">
        <img src="../assets/imgs/logosDash/logoDashboard.png" alt="" class="imagemLogoDashboard">
      </a>

      <!-- Menu -->
      <ul id="textosNavbar">
      <li class="nav-item">
        <img src="../assets/imgs/logosDash/dashboardIcon.png" alt="" id="logoNavbarDash">
        <a href="dashboard.html"> Dashboard </a>
      </li>
      <li class="nav-item active">
        <img src="../assets/imgs/logosDash/dashboardIcon.png" alt="" id="logoNavbarDash">
        <a href="dashboardIncidentes.html"> Incidentes </a>
      </li>
      <li class="nav-item">
        <img src="../assets/imgs/logosDash/avisos.png" alt="" id="logoNavbarDash">
        <a href="avisoDash.html"> Avisos </a>
      </li>
    
      <li class="nav-item" id="adm-only" style="display: none;">
        <img src="../assets/imgs/logosDash/logoGestao.png" alt="" id="logoNavbarDash">
        <a href="gestaoUsuarios.html"> Contas </a>
      </li><li class="nav-item">
        <img src="../assets/imgs/logosDash/mudarContaIcon.png" alt="" id="logoNavbarDash">
        <a href="alterarDados.html"> Alterar dados </a>
      </li>
      <li class="nav-item" id="adm-only2" style="display: none;">
        <img src="../assets/imgs/logosDash/configIcon.png" alt="" id="logoNavbarDash">
        <a href="infoConta.html"> Info. da conta </a>
      </li>
    </ul>

      <!-- Botão Sair -->
      <div id="divSair">
        <img src="../assets/imgs/logosDash/exitIcon.png" id="logoNavbarDash">
        <a href="../index.html" onclick="limparSessao()"> Sair </a>
      </div>
 </nav>

 <!-- ___________________________________________________________________________________________ -->

 <main class="container-xl">
    <h1>Dashboard de Incidentes - ITIL</h1>

    <!-- 1. KPIs DO JIRA (GLOBAL) -->
    <section class="card kpi-card">
      <header class="card-header">
        <h2 class="card-title">Status Geral dos Chamados (Jira)</h2>
      </header>
      
      <!-- Filtro de período -->
      <div class="vizor-filter" style="padding-left: 22px; padding-top: 10px;">
        <label for="periodo" style="font-size: 0.9rem; color: #ccc;">Período:</label>
        <select id="periodo" class="vizor-select" style="background:#0e1117; color:white; border:1px solid #00bcd4; border-radius:6px; padding:4px 8px;">
          <option value="24h">Últimas 24h</option>
          <option value="7d" selected>Última semana</option>
          <option value="30d">Último mês</option>
        </select>
      </div>

      <div class="card-content">
        <div class="kpi-row-4">
          <div><h4 class="kpi-label">Abertos</h4><p class="kpi-value" id="kpi-incidentes-abertos">--</p><p class="kpi-sub">Em andamento</p></div>
          <div><h4 class="kpi-label">Fechados</h4><p class="kpi-value" id="kpi-incidentes-fechados">--</p><p class="kpi-sub">Total resolvido</p></div>
          <div><h4 class="kpi-label">Tempo médio</h4><p class="kpi-value" id="kpi-tempo-resolucao">--</p><p class="kpi-sub">para resolução</p></div>
          <div><h4 class="kpi-label">SLA Cumprido</h4><p class="kpi-value" id="kpi-sla">--</p><p class="kpi-sub">No prazo</p></div>
        </div>
      </div>
    </section>

    <!-- 2. ÁREA DE ALERTAS DE HARDWARE (INTEGRAÇÃO S3 CLIENT) -->
    <!-- KPIs de Alerta Rápido -->
    <section class="alert-top-grid">
      <div class="alert-kpi">
        <div class="head"><span class="sev-dot critico"></span><span>Alertas Críticos</span></div>
        <div class="value" id="kpi-criticos">0</div>
        <div class="desc">Falhas graves de hardware/rede.</div>
      </div>
      <div class="alert-kpi">
        <div class="head"><span class="sev-dot alerta"></span><span>Em Atenção</span></div>
        <div class="value" id="kpi-alertas">0</div>
        <div class="desc">Sobrecarga ou aquecimento.</div>
      </div>
      <div class="alert-kpi">
        <div class="head"><span class="sev-dot info"></span><span>Infos</span></div>
        <div class="value" id="kpi-infos">0</div>
        <div class="desc">Monitoramento regular.</div>
      </div>
    </section>

    <!-- Lista de Alertas com Filtros -->
    <section class="card">
        <div class="alerts-header">
          <div class="alerts-header-left">
            <h2 class="card-title">Alertas de Hardware (Tempo Real)</h2>
            <small>Dados processados via AWS Lambda (Trusted -> Client)</small>
          </div>
          <div class="alerts-header-right">
            <div class="filter-group">
              <label for="filtro-severidade">Severidade</label>
              <select id="filtro-severidade" class="ui-select">
                <option value="todos" selected>Todos</option>
                <option value="CRITICO">Crítico</option>
                <option value="ALERTA">Alerta</option>
                <option value="INFO">Info</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Container onde os cards serão injetados -->
        <div class="alert-list" id="alert-list">
          <p style="text-align: center; color: #888; padding: 20px;">Carregando avisos do Data Lake...</p>
        </div>
    </section>

    <!-- 3. GRÁFICOS DO JIRA -->
    <section class="grid-2">
      <div class="card">
        <header class="card-header"><h2 class="card-title">Incidentes por Área</h2></header>
        <div class="card-content"><div class="chart-box"><canvas id="chartIncidentesArea"></canvas></div></div>
      </div>
      <div class="card">
        <header class="card-header"><h2 class="card-title">Tendência Semanal</h2></header>
        <div class="card-content"><div class="chart-box"><canvas id="chartTendenciaIncidentes"></canvas></div></div>
      </div>
    </section>

    <!-- 4. MAPA -->
    <section class="card" style="padding:16px; margin-bottom:16px;">
      <header class="card-header"><h2 class="card-title">Mapa de Calor</h2><small style="opacity:.7;">Distribuição geográfica</small></header>
      <div id="vizor-map"></div>
    </section>

    <!-- 5. BOTÃO DE RELATÓRIOS (MODAL) -->
    <section class="card" style="padding:16px; margin-bottom:16px;">
        <header class="card-header" style="margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <h2 class="card-title">Relatórios de Incidentes</h2>
            <button id="btn-open-report" class="vizor-btn" style="background: #00bcd4; color: #000; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">Abrir Relatórios</button>
        </header>
        <!-- (Conteúdo do modal oculto, mesmo do anterior) -->
        <div id="report-selector" style="display:none; background: #0e1117; padding: 15px; margin-top:10px; border-radius: 8px; border: 1px solid #333;">
            <div class="row" style="margin-bottom:8px;">
                <span class="vizor-label" style="margin-right: 10px;">Tipo:</span>
                <label class="vizor-radio"><input type="radio" name="report-type" value="semanal" checked> Semanal</label>
            </div>
            <div class="report-actions" style="margin-top: 15px;">
                <button id="btn-cancel-report" style="background:#171a20;border:1px solid #555; color: white; padding: 6px 12px; border-radius: 4px; cursor:pointer;">Cancelar</button>
                <button id="btn-generate-report" style="background:#00bcd4; color:black; border:none; padding: 6px 12px; border-radius: 4px; cursor:pointer; margin-left: 10px;">Gerar</button>
            </div>
        </div>
        <section id="report-card" class="card" style="padding:16px; margin-top:16px; display:none; border: 1px solid #00bcd4;">
            <h3 id="report-title" style="margin-top:0;">Relatório Gerado</h3>
            <div class="kpi-row-4" style="margin: 20px 0;">
                <div>Abertos: <span id="kpi-incidentes-abertos-rel" style="font-weight:bold;">-</span></div>
                <div>Resolvidos: <span id="kpi-incidentes-fechados-rel" style="font-weight:bold;">-</span></div>
            </div>
            <button id="btn-close-report" style="background:#171a20;border:1px solid #555; color: white; padding: 6px 12px; cursor:pointer;">Fechar</button>
            <button id="btn-print-report" style="background:#2fbf71; border:none; color: white; padding: 6px 12px; cursor:pointer;">Salvar PDF</button>
        </section>
    </section>

 </main>

  <!-- SCRIPTS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // --- CONFIGURAÇÃO ---
    const API_BASE_URL = "http://localhost:3333/api/jira"; 
    let globalAvisos = []; // Para armazenar e filtrar localmente

    document.addEventListener("DOMContentLoaded", () => {
      atualizarKPIsJira();
      processarAvisos();
      gerarGraficos();
    });

    // --- 1. KPIs do JIRA ---
    async function atualizarKPIsJira() {
      try {
        const response = await fetch(`${API_BASE_URL}/metricas`);
        const dados = await response.json();
        document.getElementById("kpi-incidentes-abertos").textContent = dados.aberto;
        document.getElementById("kpi-incidentes-fechados").textContent = dados.fechado;
        document.getElementById("kpi-tempo-resolucao").textContent = dados.tempoMedio + "h";
        document.getElementById("kpi-sla").textContent = dados.sla + "%";
        
        // Modal
        document.getElementById("kpi-incidentes-abertos-rel").textContent = dados.aberto;
        document.getElementById("kpi-incidentes-fechados-rel").textContent = dados.fechado;
      } catch (err) { console.error("Erro KPIs Jira", err); }
    }

    // --- 2. AVISOS E ALERTAS (S3) ---
    async function processarAvisos() {
      try {
        const response = await fetch(`${API_BASE_URL}/avisos`);
        globalAvisos = await response.json();
        
        // 2.1 Atualiza os KPIs de Alerta (Contagem)
        const criticos = globalAvisos.filter(a => a.ui.severity === "CRITICO").length;
        const alertas = globalAvisos.filter(a => a.ui.severity === "ALERTA").length;
        const infos = globalAvisos.filter(a => a.ui.severity === "INFO").length;

        document.getElementById("kpi-criticos").textContent = criticos;
        document.getElementById("kpi-alertas").textContent = alertas;
        document.getElementById("kpi-infos").textContent = infos;

        // 2.2 Renderiza a lista inicial
        renderizarListaAvisos();

      } catch (err) {
        console.error("Erro Avisos S3", err);
        document.getElementById("alert-list").innerHTML = "<p>Erro ao carregar.</p>";
      }
    }

    // Função de renderização com filtros
    function renderizarListaAvisos() {
        const container = document.getElementById("alert-list");
        container.innerHTML = "";
        
        const filtroSev = document.getElementById("filtro-severidade").value;

        // Filtra
        const filtrados = globalAvisos.filter(a => {
            return filtroSev === "todos" || a.ui.severity === filtroSev;
        });

        if (filtrados.length === 0) {
            container.innerHTML = "<p style='text-align:center; opacity:0.7;'>Nenhum aviso encontrado.</p>";
            return;
        }

        // Cria o HTML dos Cards
        filtrados.forEach(aviso => {
            // Mapeamento de estilos
            let sevClass = "info";
            if (aviso.ui.severity === "CRITICO") sevClass = "critico";
            if (aviso.ui.severity === "ALERTA") sevClass = "alerta";

            const card = document.createElement("div");
            card.className = "alert-card";
            card.innerHTML = `
                <div class="alert-main">
                    <div class="alert-headline">
                        <div class="alert-title">
                            <span>${aviso.machine_id}</span>
                            <span class="alert-status-badge ${sevClass}">${aviso.ui.severity}</span>
                        </div>
                        <div class="alert-time">${aviso.last_update}</div>
                    </div>
                    <div class="alert-subinfo">
                        <strong>${aviso.ui.title}</strong><br/>
                        ${aviso.ui.message}
                    </div>
                    <div class="alert-meta-grid">
                        <span>CPU ${aviso.raw_metrics.cpu}</span>
                        <span>Temp ${aviso.raw_metrics.temp}</span>
                        <span>RAM ${aviso.raw_metrics.ram}</span>
                        <span>Disco ${aviso.raw_metrics.disco || aviso.raw_metrics.disk}</span>
                    </div>
                </div>
                <aside class="alert-aside">
                    <div class="alert-action">
                        <strong>Ação Recomendada:</strong>
                        ${aviso.ui.action}
                    </div>
                </aside>
            `;
            container.appendChild(card);
        });
    }

    // Listener do Filtro
    document.getElementById("filtro-severidade").addEventListener("change", renderizarListaAvisos);


    // --- 3. GRÁFICOS E MAPAS (MANTIDOS DO ANTERIOR) ---
    async function gerarGraficos() {
        try {
            const response = await fetch(`${API_BASE_URL}/issues`);
            const issues = await response.json();
            // Mock de dados para gráfico (já que Jira varia muito)
            const ctxArea = document.getElementById('chartIncidentesArea').getContext('2d');
            new Chart(ctxArea, {
                type: 'bar',
                data: {
                    labels: ['Infra', 'Apps', 'Rede', 'Segurança', 'BD'],
                    datasets: [{ label: 'Incidentes', data: [18, 25, 10, 14, 20], backgroundColor: 'rgba(10,203,227,0.6)' }]
                },
                options: { responsive: true, scales: { x: { ticks: {color:'#fff'} }, y: { ticks: {color:'#fff'} } } }
            });

            const ctxTrend = document.getElementById('chartTendenciaIncidentes').getContext('2d');
            new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex'],
                    datasets: [{ label: 'Novos', data: [5, 8, 6, 10, 7], borderColor: '#ff5c5c', backgroundColor:'rgba(255,92,92,0.2)', fill:true }]
                },
                options: { responsive: true, scales: { x: { ticks: {color:'#fff'} }, y: { ticks: {color:'#fff'} } } }
            });
        } catch(e){ console.error(e); }
    }

    // Mapa Estático
    const map = L.map('vizor-map').setView([-23.5614, -46.6559], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
    const regioes = [{coords: [-23.5505, -46.6333], qtd: 25}, {coords: [-23.6445, -46.7043], qtd: 18}];
    regioes.forEach(r => L.circleMarker(r.coords, { radius: 10, color: '#ff5c5c' }).addTo(map));

    // --- LÓGICA RELATÓRIOS (MODAL) ---
    document.getElementById("btn-open-report").onclick = () => { document.getElementById("report-selector").style.display = "block"; };
    document.getElementById("btn-cancel-report").onclick = () => { document.getElementById("report-selector").style.display = "none"; };
    document.getElementById("btn-generate-report").onclick = () => {
        document.getElementById("report-card").style.display = "block";
        document.getElementById("report-selector").style.display = "none";
    };
    document.getElementById("btn-close-report").onclick = () => { document.getElementById("report-card").style.display = "none"; };
    document.getElementById("btn-print-report").onclick = async () => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const element = document.getElementById("report-card");
        const canvas = await html2canvas(element, { scale: 2, backgroundColor: "#072135" });
        pdf.addImage(canvas.toDataURL("image/png"), "PNG", 10, 10, 190, 0);
        pdf.save("Relatorio_Vizor.pdf");
    };

    // --- LÓGICA SAIR ---
    function limparSessao() {
      sessionStorage.clear();
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Usuários</title>
    <link rel="stylesheet" href="assets/css/css-dashboard/dashboard.css" />
    <link rel="stylesheet" href="assets/css/css-dashboard/navbar.css" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="icon" href="assets/imgs/logosDash/home.png" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/css-dashboard/gestao.css">
</head>

<body onload="construirLista()">
    <nav class="navbar">
        <!-- Logo -->
        <a href="#">
            <img src="assets/imgs/logosDash/logoDashboard.png" alt="" class="imagemLogoDashboard" />
        </a>

        <!-- Menu -->
        <ul id="textosNavbar">
            <li class="nav-item">
                <img src="assets/imgs/logosDash/home.png" alt="" id="logoNavbarDash" />
                <a href="inicioDash.html"> Início </a>
            </li>
            <li class="nav-item">
                <img src="assets/imgs/logosDash/logoGestao.png" alt="" id="logoNavbarDash" />
                <a href="gestaoUsuarios.html" style="color: aqua"> Painel </a>
            </li>
            <li class="nav-item">
                <img src="assets/imgs/logosDash/dashboardIcon.png" alt="" id="logoNavbarDash" />
                <a href="dashboard.html"> Dashboard </a>
            </li>
            <li class="nav-item">
                <img src="assets/imgs/logosDash/avisos.png" alt="" id="logoNavbarDash" />
                <a href="avisoDash.html"> Avisos </a>
            </li>
            <li class="nav-item">
                <img src="assets/imgs/logosDash/mudarContaIcon.png" alt="" id="logoNavbarDash" />
                <a href="alterarDados.html"> Alterar dados </a>
            </li>
            <li class="nav-item">
                <img src="assets/imgs/logosDash/configIcon.png" alt="" id="logoNavbarDash" />
                <a href="infoConta.html"> Info. da conta </a>
            </li>
        </ul>

        <!-- Botão Sair -->
        <div id="divSair">
            <img src="assets/imgs/logosDash/exitIcon.png" id="logoNavbarDash" />
            <a href="./index.html" onclick="limparSessao()"> Sair </a>
        </div>
    </nav>
    <div class="container">
        <div class="container-xl">
            <div class="cabecalho">
                <h1>Gestão de Usuários</h1>
                <button>
                    <a href="cadastro.html">
                        Cadastrar usuario
                    </a>
                </button>
            </div>
            <div class="tex">
                <p class="nomee">Nome:</p>
                <p class="telefonee">Telefone:</p>
                <p class="emaill">Email:</p>
                <p class="cargoo">Cargo:</p>
                <input placeholder="Pesquisar por nome" type="text" id="filtroNome" oninput="filtrarUsuarios()">
            </div>
            <div class="listaDeUsuarios" id="listaDeUsuarios">
            </div>
        </div>
    </div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="js/navbar.js"></script>
<script>
    let usuarios = [];


    function construirLista() {
        let codigo = sessionStorage.CODIGO;

        fetch("/dadosUsuario/listar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ codigoEmpresa: codigo })
        })
            .then(resultado => {
                listaDeUsuarios.innerHTML = ""
                resultado.json().then(json => {
                    usuarios = json;
                    console.log(json)
                    for (c = 0; c < json.length; c++) {
                        listaDeUsuarios.innerHTML +=
                            `
                            <div class="linha">
                            <div class="informacoes">
                                <div class="cabecalho-Infos">${json[c].NomeUsuario}</div>
                                <div class="dadosPessoais"><div>${json[c].Telefone}</div> <div>${json[c].EmailUsuario}</div> <div>${json[c].titulo}</div> </div>
                            </div>
                                <div class="botoes-users">    
                                    <button class="excluir" id = "botaoGestao" onclick="excluirUser(${json[c].id}, '${json[c].NomeUsuario}')">
                                        <img src="assets/imgs/logosDash/recycle-bin.png" alt="">
                                    </button>

                                    <button class="editar" id = "botaoGestao" onclick="editarUser${c}.showModal()"><img src="assets/imgs/logosDash/edit.png" alt=""></button>
                                </div>
                            </div>
                                <dialog id="editarUser${c}">
                                    <h1>${json[c].NomeUsuario}</h1>
                                    <h3>${json[c].CPF}</h3>
                                    <p>Telefone: ${json[c].Telefone}</p>
                                    <input id="ipt_telefone${json[c].id}">
                                    <p>Email: ${json[c].EmailUsuario}</p>
                                    <input id="ipt_email${json[c].id}">
                                    <p> Cargo: ${json[c].titulo}</p>
                                    <div>
                                        <select id="select_cargo${json[c].id}">
                                        
                                        </select>
                                        
                                    </div> 
                                    
                                    <button onclick="salvarEdicao(${json[c].id})">Salvar</button>
                                </dialog>
                                <dialog id="excluirUser${c}">
                                    <h1>Excluir o usuário ${json[c].NomeUsuario}</h1>
                                    <h3>${json[c].titulo}</h3>
                                    <p>Digite o nome do usuário</p>
                                    <input id="confExcluir${c}" placeholder="${json[c].NomeUsuario}">
                                    <button onclick="excluirUser(${json[c].id})">Confirmar</button>
                                </dialog>
                        `
                    }
                    fetch("/dadosUsuario/listarCargos", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    })
                        .then(resultado => resultado.json())
                        .then(cargos => {
                            for (c = 0; c < json.length; c++) {
                                for (i = 0; i < cargos.length; i++) {
                                    let select_cargo = document.getElementById("select_cargo" + json[c].id);
                                    select_cargo.innerHTML +=
                                        ` 
                                                <option value="${cargos[i].idCargo}">${cargos[i].titulo}</option> 
                                        `
                                }
                            }

                        })

                })
            })
    }


    function excluirUser(id, nomeUsuario) {
        Swal.fire({
            title: `Excluir o usuário ${nomeUsuario}?`,
            text: "Digite o nome do usuário para confirmar:",
            input: "text",
            inputPlaceholder: nomeUsuario,
            showCancelButton: true,
            confirmButtonText: "Excluir",
            cancelButtonText: "Cancelar",
            background: "rgb(0,0,0,0.9)",
            color: "#f1f1f1",
            heightAuto: false,
            customClass: {
                popup: 'alerta-custom',
                title: 'alerta-titulo',
                icon: 'alerta-icone'
            },
            preConfirm: (valorDigitado) => {
                if (valorDigitado !== nomeUsuario) {
                    Swal.showValidationMessage("Nome incorreto! Digite exatamente como aparece.");
                    return false;
                }
                return true;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // Se o usuário confirmou e digitou certo, chama o fetch
                fetch(`usuarios/deletarUsuario/${id}`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                    }
                })
                    .then((resposta) => {
                        if (resposta.ok) {
                            Swal.fire({
                                icon: "success",
                                title: "Usuário deletado com sucesso!",
                                timer: 3000,
                                showConfirmButton: false,
                                background: "rgb(0,0,0,0.9)",
                                color: "#f1f1f1",
                                heightAuto: false,
                                customClass: {
                                    popup: 'alerta-custom',
                                    title: 'alerta-titulo',
                                    icon: 'alerta-icone'
                                },
                            });

                            // Atualiza a lista
                            construirLista();

                        } else {
                            Swal.fire({
                                icon: "error",
                                title: "Erro ao deletar usuário!",
                                timer: 3000,
                                showConfirmButton: false,
                                background: "rgb(0,0,0,0.9)",
                                color: "#f1f1f1",
                                heightAuto: false,
                                customClass: {
                                    popup: 'alerta-custom',
                                    title: 'alerta-titulo',
                                    icon: 'alerta-icone'
                                },
                            });
                        }
                    })
                    .catch((erro) => {
                        console.error("Erro no fetch: ", erro);
                        Swal.fire("Erro", "Não foi possível excluir o usuário", "error");
                    });
            }
        });
    }


    function salvarEdicao(id) {
        console.log(id)
        novoTelefoneUser = document.getElementById("ipt_telefone" + id).value
        novoEmailUser = document.getElementById("ipt_email" + id).value
        novoCargoUser = document.getElementById("select_cargo" + id).value

        fetch(`usuarios/atualizarUsuario/${id}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                emailServer: novoEmailUser,
                telefoneServer: novoTelefoneUser,
                cargoServer: novoCargoUser
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);
                if (resposta.ok) {
                    Swal.fire({
                        position: "center",
                        icon: "success",
                        title: "Usuario atualizado com sucesso!",
                        showConfirmButton: false,
                        timer: 4000,
                        background: "rgb(0,0,0,0.9)",
                        color: "#f1f1f1",
                        heightAuto: false,
                        customClass: {
                            popup: 'alerta-custom',   // caixa toda
                            title: 'alerta-titulo',   // só o título
                            icon: 'alerta-icone'      // só o ícone
                        }
                    });
                    editarUserId = document.getElementById(editarUser + (id - 1))
                    setTimeout(() => {
                        editarUserId(c - 1).close();
                    }, "8000");
                } else {
                    Swal.fire({
                        position: "center",
                        icon: "error",
                        title: "Erro ao atualizar usuário!",
                        showConfirmButton: false,
                        timer: 4000,
                        background: "rgb(0,0,0,0.9)",
                        color: "#f1f1f1",
                        heightAuto: false,
                        customClass: {
                            popup: 'alerta-custom',   // caixa toda
                            title: 'alerta-titulo',   // só o título
                            icon: 'alerta-icone'      // só o ícone
                        }
                    });
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

    }

    function filtrarUsuarios() {
        const termo = document.getElementById("filtroNome").value.toLowerCase();
        const lista = document.getElementById("listaDeUsuarios");
        lista.innerHTML = "";

        usuarios.forEach(user => {
            if (user.NomeUsuario.toLowerCase().includes(termo)) {
                lista.innerHTML += `
                <div class="linha">
                    <div class="informacoes">
                        <div class="cabecalho-Infos">${user.NomeUsuario}:</div>
                        <div class="dadosPessoais">
                            <div>${user.Telefone}</div> 
                            <div>${user.EmailUsuario}</div> 
                            <div>${user.titulo}</div>
                        </div>
                    </div>
                    <div class="botoes-users">    
                        <button class="excluir" onclick="document.getElementById('excluirUser${user.id}').showModal()">
                            <img src="assets/imgs/logosDash/recycle-bin.png" alt="">
                        </button>
                        <button class="editar" onclick="document.getElementById('editarUser${user.id}').showModal()">
                            <img src="assets/imgs/logosDash/edit.png" alt="">
                        </button>
                    </div>
                </div>
                <dialog id="editarUser${user.id}">
                    <h1>${user.NomeUsuario}</h1>
                    <h3>${user.CPF}</h3>
                    <p>Telefone: ${user.Telefone}</p>
                    <input id="ipt_telefone${user.id}">
                    <p>Email: ${user.EmailUsuario}</p>
                    <input id="ipt_email${user.id}">
                    <p>Cargo: ${user.titulo}</p>
                    <div>
                        <select id="select_cargo${user.id}"></select>
                    </div>
                    <button onclick="salvarEdicao(${user.id})">Salvar</button>
                </dialog>
            `;
            }
        });
    }
</script>
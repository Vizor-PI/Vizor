<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../assets/css/css-dashboard/navbar.css" />
  <link rel="stylesheet" href="../assets/css/css-dashboard/cadastroUsuario.css" />
  <link rel="icon" href="assets/imgs/logosDash/logoDashboard.png" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />

  <title>Cadastro</title>
</head>

<body onload="buscarEmpresas()">
  <div class="cadastroContainer">
    <div class="divCentralCadastro">
      <a href="./gestaoUsuarios.html"><img src="../assets/imgs/Logo.png" id="logoVizor" /></a>
      <h1>Cadastro de usuários</h1>
      <div class="entradasCadastro">
        <div class="input">
          <p class="textoInput">Nome de usuário</p>
          <input id="nome_input" placeholder="Usuário" />
        </div>
        <div class="input">
          <p class="textoInput">CPF</p>
          <input id="cpf_input" placeholder="XXX. XXX. XXX -XX" />
        </div>
        <div class="input">
          <p class="textoInput">Email</p>
          <input id="email_input" placeholder="usuario@email.com" />
        </div>
        <div class="input">
          <p class="textoInput">numero de telefone</p>
          <input id="telefone_input" placeholder="(XX) XXXXX-XXXX" />
        </div>
        <div class="input">
          <p class="textoInput">Senha</p>
          <input id="senha_input" placeholder="****************" type="password" />
        </div>
        <div class="input">
          <p class="textoInput">Confirme a senha</p>
          <input id="confirmacao_senha_input" placeholder="****************" type="password" />
        </div>
        <div class="input-Container" style="flex-direction: row; display: flex">
          <p class="textoInput">Cargo</p>
          <select id="cargo_input">
            <option value="2">Gestor de produtos</option>
            <option value="3">Engenheiro de qualidade</option>
          </select>
        </div>
      </div>
      <button onclick="cadastrar()">Cadastrar</button>
      <p style="color: white" id="textoInstrucao">
        <span style="color: rgba(10, 203, 227, 1); cursor: pointer" id="textoInstrucao"
          onclick="instrucoesSenha()">Instruções de cadastro
        </span>
      </p>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.js"></script>

  <div id="mensagem_erro"></div>
  <div id="cardErro"></div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/public/js/alertasSW.js"></script>

<script>
  // Array para armazenar empresas cadastradas para validação de código de ativação
  let listaEmpresasCadastradas = [];

  function buscarEmpresas() {
    fetch("/empresa/buscar", {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((empresa) => {
          empresa.forEach((empresa) => {
            listaEmpresasCadastradas.push(empresa);
            console.log("listaEmpresasCadastradas");
            console.log(listaEmpresasCadastradas[0].Codigo);
          });
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function instrucoesSenha() {
    Swal.fire({
      title: "Instruções de senha",
      html: `
      <b>Senha:</b><br>
      • Deve ter no mínimo 6 caracteres.<br>
      • Deve conter ao menos uma letra maiúscula.<br>
      • Deve conter pelo menos um caractere especial (ex: @, #, !, %, etc).<br>
      • A confirmação de senha deve ser idêntica à senha escolhida.<br><br>

      <b>E-mail:</b><br>
      • O e-mail informado deve conter o símbolo <b>@</b>.<br>
      • O campo de confirmação de e-mail deve ser igual ao e-mail digitado.<br><br>

      <b>CPF:</b><br>
      • Deve conter exatamente 11 dígitos numéricos, sem pontos ou traços.
    `,
      icon: "question",
      heightAuto: false,
      background: "rgb(0,0,0,0.9)",
      color: "#fff",
      customClass: {
        popup: "alerta-custom-senha",
        title: "alerta-titulo",
        icon: "alerta-icone",
      },
    });
  }

  // Função genérica para todos os alertas
  function alerta(icone, texto) {
    Swal.fire({
      position: "center",
      icon: icone,
      title: texto,
      showConfirmButton: false,
      timer: 4000,
      background: "rgb(0,0,0,0.9)",
      color: "#f1f1f1",
      heightAuto: false,
      customClass: {
        popup: "alerta-custom",
        title: "alerta-titulo",
        icon: "alerta-icone",
      },
    });
  }

  function cadastrar() {
    var nomeVar = document.getElementById("nome_input").value;
    var emailVar = document.getElementById("email_input").value;
    var senhaVar = document.getElementById("senha_input").value;
    var confirmacaoSenhaVar = document.getElementById(
      "confirmacao_senha_input"
    ).value;
    var cpfVar = document.getElementById("cpf_input").value;
    var telefoneVar = document.getElementById("telefone_input").value;
    var cargoVar = document.getElementById("cargo_input").value;
    var codigoEmpresa = sessionStorage.getItem("CODIGO");

    var textoComArroba = emailVar.indexOf("@");
    const regex = /[!@#$%^&*(),.?":{}|<>]/;
    const regexLetra = /[A-Z]/;

    if (
      nomeVar == "" ||
      emailVar == "" ||
      senhaVar == "" ||
      confirmacaoSenhaVar == "" ||
      cpfVar == "" ||
      telefoneVar == "" ||
      cargoVar == ""
    ) {
      alerta("warning", "Todos os campos devem ser preenchidos!");
      return;
    }
    if (senhaVar.length < 6) {
      alerta("error", "Sua senha deve ter mais de 6 caracteres!");
      return;
    }
    if (confirmacaoSenhaVar != senhaVar) {
      alerta("error", "As senhas não correspondem!");
      return;
    }
    if (textoComArroba < 0) {
      alerta("error", "Seu email deve conter um @!");
      return;
    }
    if (!regex.test(senhaVar)) {
      alerta("error", "Sua senha deve ter um caractere especial!");
      return;
    }
    if (!regexLetra.test(senhaVar)) {
      alerta("error", "Sua senha deve conter uma letra maiúscula!");
      return;
    }

    var cpfApenasNumeros = cpfVar.replace(/\D/g, "");
    if (cpfApenasNumeros.length != 11) {
      alerta("error", "Seu CPF deve conter exatamente 11 dígitos!");
      return;
    }

    var telefoneApenasNumeros = telefoneVar.replace(/\D/g, "");
    if (telefoneApenasNumeros.length < 11) {
      alerta("error", "Seu telefone deve conter 11 dígitos (DDD + Número)!");
      return;
    }

    fetch("/usuarios/cadastrar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        nomeServer: nomeVar,
        emailServer: emailVar,
        senhaServer: senhaVar,
        cpfServer: cpfApenasNumeros,
        telefoneServer: telefoneApenasNumeros,
        codigoEmpresa: codigoEmpresa,
        cargoServer: cargoVar,
      }),
    })
      .then(function (resposta) {
        if (resposta.ok) {
          Swal.fire({
            icon: "success",
            title: "Usuário cadastrado com sucesso!",
            showConfirmButton: false,
            heightAuto: false,
            background: "rgb(0,0,0,0.9)",
            color: "#fff",
            timer: 2000,
            customClass: {
              popup: "alerta-custom",
              title: "alerta-titulo",
              icon: "alerta-icone",
            },
          }).then(() => {
            window.location = "gestaoUsuarios.html";
          });
        } else {

          resposta.text().then(textoErro => {
            alerta("error", `${textoErro}`)
            return
          })
          alerta("error", "Erro ao realizar o cadastro");
        }
      })
      .catch(function (erro) {
        console.log(`#ERRO: ${erro}`);
        alerta("error", "Ocorreu um erro de comunicação com o servidor.");
      });
  }
</script>
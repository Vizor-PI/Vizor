<!DOCTYPE html>  
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard — Monitoramento de Hardware</title>

  <link rel="stylesheet" href="../assets/css/css-dashboard/dashboard.css" />
  <link rel="stylesheet" href="../assets/css/css-dashboard/navbar.css" />

  <link rel="icon" href="../assets/imgs/logosDash/home.png" type="image/x-icon" />

  <!-- CSS do Leaflet (biblioteca do mapa) -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>

  <style>
    .vizor-btn{
      padding:8px 12px; border-radius:10px; border:1px solid transparent;
      cursor:pointer; background:#2b8fff; color:#fff
    }
    .vizor-btn:hover{ filter:brightness(1.05) }

    .vizor-select{
      padding:6px 10px; border-radius:10px; background:#0f1216; color:#fff;
      border:1px solid rgba(255,255,255,.15)
    }

    .vizor-radio{
      display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px;
      background:#0f1216; border:1px solid rgba(255,255,255,.1)
    }
    .vizor-label{ font-size:14px; opacity:.9 }

    .report-selector{
      display:none; margin-top:8px; padding:12px; border-radius:12px;
      background:#111317; color:#fff; border:1px solid rgba(255,255,255,.08)
    }
    .report-selector .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    .report-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:8px }

    #report-card{ display:none; margin-top:16px }
    .kpi-mini{
      display:grid; grid-template-columns:repeat(4,minmax(120px,1fr));
      gap:12px; margin-top:8px
    }
    .kpi-mini .mini{
      background:#111317; border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:10px
    }
    .mini .label{ opacity:.8; font-size:12px }
    .mini .value{ font-size:20px; font-weight:700 }
    .mini .sub{ opacity:.7; font-size:12px }

    .vizor-status-badge{ display:inline-block; padding:2px 8px; font-size:12px; border-radius:999px; font-weight:600 }
    .vizor-status-ok{ background:#e6ffed; color:#0a7f2e }
    .vizor-status-alerta{ background:#fff8e6; color:#a66300 }
    .vizor-status-risco{ background:#ffe6e6; color:#a40000 }

    #vizor-map{
      width:100%; height:420px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); overflow:hidden
    }
    .vizor-map-controls{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px }
    .vizor-map-controls .vizor-btn,
    .vizor-map-controls .vizor-select{ padding:6px 10px }
  </style>
</head>
<body onload="verificarCargo()">
  <nav class="navbar" id="navbarConstructor"></nav>

  <div class="container-xl">

    <section class="kpi-grid">
      <div class="card kpi-card">
        <h4 class="kpi-label">CPU</h4>
        <p class="kpi-value">10%</p>
        <p class="kpi-sub">Média nas últimas 24h</p>
      </div>

      <div class="card kpi-card">
        <h4 class="kpi-label">RAM</h4>
        <p class="kpi-value">49%</p>
        <p class="kpi-sub">Média nas últimas 24h</p>
      </div>

      <div class="card kpi-card">
        <h4 class="kpi-label">DISCO</h4>
        <p class="kpi-value">12%</p>
        <p class="kpi-sub">Média nas últimas 24h</p>
      </div>

      <div class="card kpi-card">
        <h4 class="kpi-label">Temperatura CPU</h4>
        <p class="kpi-value">66ºC</p>
        <p class="kpi-sub">Média nas últimas 24h</p>
      </div>
    </section>

    <!-- Card do mapa: botão de relatórios, os controles e mapa -->
    <section class="card" style="padding:16px; margin-top:16px;">
      <header class="card-header" style="margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <h2 class="card-title">Mapa de Dispositivos — Vizor</h2>
        <!-- Botão que mostra o select de relatório -->
        <button id="btn-open-selector" class="vizor-btn" title="Gerar relatório (na própria página)">Relatórios</button>
      </header>

      <div class="card-content">
        <!-- Seletor de relatório -->
        <div id="report-selector" class="report-selector" aria-label="Seletor de relatório">
          <div class="row" style="margin-bottom:8px">
            <span class="vizor-label">Tipo de relatório:</span>
            <label class="vizor-radio"><input type="radio" name="report-type" value="dooh"> DOOH específico</label>
            <label class="vizor-radio"><input type="radio" name="report-type" value="semanal" checked> Geral semanal</label>
            <!-- Este select só aparece quando escolhe um DOOH específico -->
            <div id="dooh-select-wrap" style="display:none">
              <select id="select-dooh" class="vizor-select">
                <option value="">— Selecione o DOOH —</option>
              </select>
            </div>
          </div>
          <div class="report-actions">
            <button id="btn-cancel-selector" class="vizor-btn" style="background:#171a20;border:1px solid rgba(255,255,255,.15)">Cancelar</button>
            <button id="btn-generate-inline" class="vizor-btn">Gerar relatório</button>
          </div>
        </div>

        <!-- Controles do mapa: localização, centralizar e filtro -->
        <div class="vizor-map-controls">
          <button id="btn-geolocate" class="vizor-btn" title="Centraliza em você">Minha localização</button>
          <button id="btn-fit" class="vizor-btn" title="Centraliza e enquadra todos os players visíveis no mapa">Centralizar</button>
          <select id="filtro-status" class="vizor-select" aria-label="Filtro do mapa por status">
            <option value="todos" selected>Filtrar: todos</option>
            <option value="ok">Somente OK</option>
            <option value="alerta">Somente ALERTA</option>
            <option value="risco">Somente RISCO</option>
          </select>
        </div>

        <!-- Aqui o Leaflet renderiza o mapa -->
        <div id="vizor-map"></div>

        <!-- Card do relatório -->
        <section id="report-card" class="card" style="padding:16px; margin-top:16px;">
          <header class="card-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <div>
              <h3 id="report-title" class="card-title" style="margin:0;">Relatório</h3>
              <small id="report-period" style="opacity:.8"></small>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <!-- Abre a janela de impressão -->
              <button id="btn-print-report" class="vizor-btn" title="Imprimir / Salvar PDF">Imprimir</button>
              <!-- Esconde o card do relatório -->
              <button id="btn-close-report" class="vizor-btn" style="background:#171a20;border:1px solid rgba(255,255,255,.15)">Fechar</button>
            </div>
          </header>
          <div class="card-content">
            <!-- KPIs do relatório -->
            <div class="kpi-mini">
              <div class="mini"><div class="label">Disponibilidade</div><div id="kpi-up" class="value">—</div><div class="sub">últimos 7 dias</div></div>
              <div class="mini"><div class="label">Alertas</div><div id="kpi-alert" class="value">—</div><div class="sub">semana</div></div>
              <div class="mini"><div class="label">Uso médio CPU</div><div id="kpi-cpu" class="value">—</div><div class="sub">semana</div></div>
              <div class="mini"><div class="label">Tickets</div><div id="kpi-tickets" class="value">—</div><div class="sub">semana</div></div>
            </div>
            <!-- Gráfico do relatório semanal-->
            <div style="margin-top:12px">
              <canvas id="reportChart" height="140"></canvas>
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- Gráficos gerais da dash  -->
    <section class="grid-2">
      <div class="card">
        <header class="card-header">
          <h2 class="card-title">Uso de CPU (média por hora)</h2>
        </header>
        <div class="card-content">
          <div class="chart-box">
            <canvas id="chartCPU"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <h2 class="card-title">Uso de RAM (média por hora)</h2>
        </header>
        <div class="card-content">
          <div class="chart-box">
            <canvas id="chartRAM"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <h2 class="card-title">Uso de Disco (média por hora)</h2>
        </header>
        <div class="card-content">
          <div class="chart-box">
            <canvas id="chartDISCO"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <h2 class="card-title">Temperatura (média por hora)</h2>
        </header>
        <div class="card-content">
          <div class="chart-box">
            <canvas id="chartGPU"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Tabelas por status -->
    <section class="card table-card">
      <header class="card-header">
        <h2 class="card-title">Equipamentos por status</h2>
        <div class="card-actions">
          <label for="seletor-lista" class="ui-label">Tipo de lista:</label>
          <select id="seletor-lista" class="ui-select">
            <option value="todos" selected>Todos os DOOH</option>
            <option value="risco">Crítico</option>
            <option value="alerta">Alerta</option>
            <option value="ok">OK</option>
          </select>
        </div>
      </header>

      <div class="card-content">
        <!-- Todos -->
        <div id="lista-todos" class="lista-visivel">
          <table class="ui-table" id="tabela-dooh">
            <thead>
              <tr>
                <th>Hostname</th><th>CPU</th><th>RAM</th><th>Disco</th><th>Último ping</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="tbody-todos"></tbody> 
          </table>
        </div>

        <!-- Risco -->
        <div id="lista-risco" class="lista-oculta">
          <table class="ui-table">
            <thead>
              <tr>
                <th>Hostname</th><th>CPU</th><th>RAM</th><th>Disco</th><th>Último ping</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="tbody-risco"></tbody> 
          </table>
        </div>

        <!-- Alerta -->
        <div id="lista-alerta" class="lista-oculta">
          <table class="ui-table">
            <thead>
              <tr>
                <th>Hostname</th><th>CPU</th><th>RAM</th><th>Disco</th><th>Último ping</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="tbody-alerta"></tbody> 
          </table>
        </div>

        <!-- OK -->
        <div id="lista-ok" class="lista-oculta">
          <table class="ui-table">
            <thead>
              <tr>
                <th>Hostname</th><th>CPU</th><th>RAM</th><th>Disco</th><th>Último ping</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="tbody-ok"></tbody> 
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Scripts que já existiam -->
  <script src="../js/verificadorCargo.js"></script>
  <script src="../js/navbar.js"></script>

  <!-- JS do Leaflet pra criar e controlar o mapa -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <!-- JS do Chart.js  -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
 
    const colorText = '#ffffff';
    const colorGrid = 'rgba(255,255,255,0.10)';
    const colorCPU  = 'rgba(10, 203, 227, 1)';
    const colorRAM  = 'rgba(79, 209, 197, 1)';
    const colorDISK = 'rgba(255, 92, 92, 1)';
    const colorGPU  = 'rgba(53, 162, 235, 1)';

    const horas = ['00h','02h','04h','06h','08h','10h','12h','14h','16h','18h','20h','22h'];

    const serieCPU   = [22,18,25,30,45,61,68,74,71,63,48,35];
    const serieRAM   = [38,35,41,46,52,55,58,60,57,54,50,49];
    const serieDISCO = [12,13,12,11,13,14,12,13,11,12,12,12];
    const serieGPU   = [50,56,49,62,66,69,72,65,68,62,59,64];

    // Função que cria um gráfico de linha
    function criarLinha(idCanvas, rotulo, dados, cor){
      const ctx = document.getElementById(idCanvas).getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: horas,
          datasets: [{
            label: rotulo,
            data: dados,
            borderColor: cor,
            backgroundColor: cor.replace('1)', '0.15)'), 
            fill: true,
            tension: 0.35,
            pointRadius: 2.5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { grid: { color: colorGrid }, ticks: { color: colorText } },
            y: { beginAtZero: true, max: 100, grid: { color: colorGrid }, ticks: { stepSize: 20, color: colorText } }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: { callbacks: { label: (ctx) => ` ${ctx.dataset.label}: ${ctx.parsed.y}%` } }
          }
        }
      });
    }

    // Crio os 4 gráficos
    criarLinha('chartCPU',   'CPU (%)',   serieCPU,   colorCPU);
    criarLinha('chartRAM',   'RAM (%)',   serieRAM,   colorRAM);
    criarLinha('chartDISCO', 'Disco (%)', serieDISCO, colorDISK);
    criarLinha('chartGPU',   'Temperatura (ºC)',   serieGPU,   colorGPU);

    // Controle das abas da tabela. Quando troco aqui, também filtro o mapa.
    const seletor = document.getElementById('seletor-lista');
    const blocos = {
      todos : document.getElementById('lista-todos'),
      risco : document.getElementById('lista-risco'),
      alerta: document.getElementById('lista-alerta'),
      ok    : document.getElementById('lista-ok')
    };

    seletor.addEventListener('change', () => {
      const chave = seletor.value;
      // Mostro só a aba correspondente
      Object.values(blocos).forEach(div => div.classList.add('lista-oculta'));
      blocos[chave].classList.remove('lista-oculta');
      // Aplico o mesmo filtro no mapa 
      if (window.vizorMap && typeof window.vizorMap.filterStatus === 'function') {
        window.vizorMap.filterStatus(chave);
      }
    });
  </script>

  <script>
  (function() {
    const USE_API = false; // quando tiver backend, troco pra true
    const ENDPOINT = '/api/dispositivos?zona=paulista'; // já traz só Paulista

    // Cores dos marcadores de acordo com o status
    const STATUS_STYLE = {
      ok:     { color: '#0a7f2e', fillColor: '#27ae60' },
      alerta: { color: '#a66300', fillColor: '#f39c12' },
      risco:  { color: '#a40000', fillColor: '#e74c3c' }
    };

    // Variáveis de estado
    let map, markersLayer, allDevices = [], currentFilter = 'todos';
    let reportChart; // guardo a instância do Chart pra conseguir destruir antes de recriar

    /* ------ Criação do mapa e configuração básica ------ */
    function initMap() {
      // Inicio a visão no centro da Av. Paulista
      map = L.map('vizor-map', { zoomControl: true, minZoom: 2 })
             .setView([-23.5614, -46.6559], 12);

      // Camada de azulejos (tiles) que mostra as ruas etc.
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // Grupo que segura todos os marcadores. Fica fácil limpar e replotar
      markersLayer = L.layerGroup().addTo(map);

      // Ações dos controles do mapa
      document.getElementById('btn-geolocate')?.addEventListener('click', goToMyLocation);
      document.getElementById('btn-fit')?.addEventListener('click', fitToMarkers);
      document.getElementById('filtro-status')?.addEventListener('change', (e) => {
        filterStatus(e.target.value || 'todos');
      });
    }

    /* ------ Carrego os dados (mock por enquanto) ------ */
    async function loadData() {
      if (USE_API) {
        try {
          const resp = await fetch(ENDPOINT, { cache: 'no-store' });
          if (!resp.ok) throw new Error('Falha ao buscar dispositivos');
          const data = await resp.json();
          allDevices = (Array.isArray(data) ? data : []).map(normalizeDevice);
        } catch (e) {
          console.warn('Falha na API, seguindo com mock:', e);
          allDevices = getMockPaulista();
        }
      } else {
        allDevices = getMockPaulista();
      }

      // A partir daqui, eu renderizo tudo usando allDevices
      applyRender();                      // desenha os marcadores com base no filtro
      fitToMarkers();                     // ajusta o mapa pra enquadrar os pontos
      renderTablesFromDevices(allDevices);        // preenche as tabelas
      hydrateDoohSelectFromDevices(allDevices);   // preenche o select do relatório
    }



    /* ------ Atualiza o mapa conforme o filtro atual ------ */
    function applyRender() {
      const list = currentFilter === 'todos'
        ? allDevices
        : allDevices.filter(d => (d.status||'').toLowerCase() === currentFilter);
      renderMarkers(list);
    }

    /* ------ Criação e desenho dos marcadores ------ */
    function renderMarkers(list) {
      markersLayer.clearLayers();
      list.forEach(dev => {
        if (!isFinite(dev.lat) || !isFinite(dev.lng)) return;

        const sKey = (dev.status || 'ok').toLowerCase();
        const style = STATUS_STYLE[sKey] || STATUS_STYLE.ok;

        L.circleMarker([dev.lat, dev.lng], {
          radius: 8, weight: 2, color: style.color, fillColor: style.fillColor, fillOpacity: 0.8
        })
        .addTo(markersLayer)
        .bindPopup(buildPopupHTML(dev), { maxWidth: 280 });
      });
    }

    /* ------ HTML da popup de cada ponto ------ */
    function buildPopupHTML(dev) {
      const st = (dev.status || 'ok').toLowerCase();
      const badgeClass =
        st==='risco' ? 'vizor-status-badge vizor-status-risco' :
        st==='alerta'? 'vizor-status-badge vizor-status-alerta' :
                       'vizor-status-badge vizor-status-ok';
      const atualizado = dev.ultimoUpdateISO ? new Date(dev.ultimoUpdateISO).toLocaleString() : '—';

      return `
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <strong>${dev.nome || dev.hostname || ('Media Player #' + (dev.id ?? '?'))}</strong>
            <span class="${badgeClass}">${st.toUpperCase()}</span>
          </div>
          <div style="margin-top:6px;font-size:13px;line-height:1.35;">
            <div><b>ID/Hostname:</b> ${dev.hostname ?? dev.id ?? '-'}</div>
            <div><b>Último update:</b> ${atualizado}</div>
            ${dev.endereco ? `<div><b>Endereço:</b> ${dev.endereco}</div>` : ''}
          </div>
        </div>`;
    }

    /* ------ Funções de usabilidade no mapa ------ */
    function fitToMarkers() {
      const bounds = L.latLngBounds();
      markersLayer.eachLayer(layer => { if (layer.getLatLng) bounds.extend(layer.getLatLng()); });
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.15));
    }

    function goToMyLocation() {
      if (!navigator.geolocation) return alert('Geolocalização não suportada.');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 14);
          L.circleMarker([latitude, longitude], {
            radius: 6, weight: 2, color: '#3b82f6', fillColor: '#60a5fa', fillOpacity: 0.8
          }).addTo(map).bindPopup('Você está aqui').openPopup();
        },
        () => alert('Não foi possível obter sua localização.'),
        { enableHighAccuracy: true, timeout: 8000 }
      );
    }

    function filterStatus(value) {
      currentFilter = (value || 'todos').toLowerCase();

      // Mantém o select de status do mapa sincronizado com a troca vinda da tabela
      const mapSelect = document.getElementById('filtro-status');
      if (mapSelect && mapSelect.value !== currentFilter && ['todos','ok','alerta','risco'].includes(currentFilter)) {
        mapSelect.value = currentFilter;
      }

      // Reaplico no mapa e atualizo as tabelas pra bater tudo
      applyRender();
      fitToMarkers();
      renderTablesFromDevices(allDevices);
    }

    /* ------ Mock com DOOHs ------ */
    function getMockPaulista() {
      const now = new Date().toISOString();
      const base = [
        [-23.56192,-46.65544,'Paulista - DOOH001'],
        [-23.56349,-46.65380,'Paulista - DOOH002'],
        [-23.55580,-46.66304,'Paulista - DOOH003'],
        [-23.56917,-46.64730,'Paulista - DOOH004'],
        [-23.56527,-46.65136,'Paulista - DOOH005'],
        [-23.57502,-46.64149,'Paulista - DOOH006'],
        [-23.55783,-46.66001,'Paulista - DOOH007'],
        [-23.56467,-46.65697,'Paulista - DOOH008'],
        [-23.57085,-46.64515,'Paulista - DOOH009'],
        [-23.57099,-46.64430,'Paulista - DOOH010'],
        [-23.55430,-46.66106,'Paulista - DOOH011'],
        [-23.56210,-46.65551,'Paulista - DOOH012'],
      ];
      return base.map((p, i) => ({
        id: 100 + i,
        hostname: `DOOH-SP-P${String(i+1).padStart(2,'0')}`,
        nome: `Media Player ${p[2]}`,
        status: i % 5 === 0 ? 'risco' : (i % 3 === 0 ? 'alerta' : 'ok'),
        lat: p[0],
        lng: p[1],
        ultimoUpdateISO: now,
        endereco: 'Av. Paulista, São Paulo',
        // Métricas simples pra tabela (apenas pra exemplo visual)
        cpu: 55 + (i*3 % 40),
        ram: 45 + (i*4 % 40),
        disco: 30 + (i*2 % 50),
        ultimoPing: (i%3===0?'há 1 min':i%3===1?'há 40 s':'há 5 min')
      }));
    }

    /* ------ Preenchimento das tabelas usando allDevices ------ */
    function renderTablesFromDevices(devices){
      const tTodos   = document.getElementById('tbody-todos');
      const tRisco   = document.getElementById('tbody-risco');
      const tAlerta  = document.getElementById('tbody-alerta');
      const tOk      = document.getElementById('tbody-ok');
      if (!tTodos || !tRisco || !tAlerta || !tOk) return;

      [tTodos,tRisco,tAlerta,tOk].forEach(t=> t.innerHTML = '');

      const addRow = (tbody, d) => {
        const badgeClass = d.status==='risco'?'badge badge--crit'
                         : d.status==='alerta'?'badge badge--warn'
                         : 'badge badge--ok';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a class="host-link" href="./dooh-detalhe.html?id=${encodeURIComponent(d.hostname)}">${d.hostname}</a></td>
          <td>${d.cpu}%</td>
          <td>${d.ram}%</td>
          <td>${d.disco}%</td>
          <td>${d.ultimoPing}</td>
          <td><span class="${badgeClass}">${d.status === 'risco' ? 'Crítico' : (d.status === 'alerta' ? 'Alerta' : 'OK')}</span></td>
        `;
        tbody.appendChild(tr);
      };

      // Abas: todos e as separadas por status
      devices.forEach(d => addRow(tTodos, d));
      devices.filter(d=>d.status==='risco').forEach(d=> addRow(tRisco, d));
      devices.filter(d=>d.status==='alerta').forEach(d=> addRow(tAlerta, d));
      devices.filter(d=>d.status==='ok').forEach(d=> addRow(tOk, d));
    }

    /* ------ Preencho o <select> do relatório com os mesmos DOOHs do mapa ------ */
    function hydrateDoohSelectFromDevices(devices){
      const $selDooh = document.getElementById('select-dooh');
      if (!$selDooh) return;
      $selDooh.innerHTML = '<option value="">— Selecione o DOOH —</option>';
      devices.forEach(d=>{
        const opt = document.createElement('option');
        opt.value = d.hostname;
        opt.textContent = d.hostname;
        $selDooh.appendChild(opt);
      });
    }

    /* ------ Lógica do relatório inline (mostrar seletor, gerar e montar o gráfico) ------ */
    const $selector = document.getElementById('report-selector');
    const $openSel1 = document.getElementById('btn-open-selector');   // botão do card do mapa
    const $openSel2 = document.getElementById('btn-open-selector-2'); // deixei o id reservado caso eu use 
    const $cancelSel = document.getElementById('btn-cancel-selector');
    const $btnGen = document.getElementById('btn-generate-inline');
    const $wrapDooh = document.getElementById('dooh-select-wrap');
    const $selDooh = document.getElementById('select-dooh');
    const $reportCard = document.getElementById('report-card');
    const $reportTitle = document.getElementById('report-title');
    const $reportPeriod = document.getElementById('report-period');
    const $btnCloseReport = document.getElementById('btn-close-report');
    const $btnPrintReport = document.getElementById('btn-print-report');

    // Mostrar/ocultar a área do seletor
    function toggleSelector(show){ $selector.style.display = show?'block':'none'; }

    // Qual tipo de relatório está marcado
    function selectedType(){
      const r = document.querySelector('input[name="report-type"]:checked');
      return r ? r.value : 'semanal';
    }

    // Quando eu mudo entre dooh e semanal, eu exibo ou escondo o select de DOOH
    document.addEventListener('change', (e)=>{
      if (e.target && e.target.name === 'report-type'){
        $wrapDooh.style.display = e.target.value === 'dooh' ? 'inline-block' : 'none';
      }
    });

    // Abre o seletor
    $openSel1?.addEventListener('click', ()=>{ toggleSelector(true); });
    $openSel2?.addEventListener('click', ()=>{ toggleSelector(true); });

    // Cancela o seletor
    $cancelSel?.addEventListener('click', ()=> toggleSelector(false));

    // Gera o relatório: valida entradas, preenche KPIs e gráfico, e rola até o card
    $btnGen?.addEventListener('click', ()=>{
      const type = selectedType();
      if (type === 'dooh' && !$selDooh.value){ alert('Selecione um DOOH.'); return; }
      renderReport(type, $selDooh.value);
      toggleSelector(false);
      $reportCard.style.display = 'block';
      $reportCard.scrollIntoView({behavior:'smooth', block:'start'});
    });

    // Fecha o card do relatório
    $btnCloseReport?.addEventListener('click', ()=>{ $reportCard.style.display='none'; });

    // Abre a impressão
    $btnPrintReport?.addEventListener('click', ()=>{ window.print(); });

    // Monta os dados do relatório e desenha o gráfico
    function renderReport(type, id){
      // Período: últimos 7 dias incluindo hoje
      const end = new Date();
      const start = new Date(); start.setDate(end.getDate()-6);
      const fmt = (d)=> d.toLocaleDateString('pt-BR');
      $reportPeriod.textContent = `Período: ${fmt(start)} a ${fmt(end)}`;

      // Título depende se é geral ou de um DOOH específico
      $reportTitle.textContent = (type==='dooh') ? `Relatório — ${id}` : 'Relatório — Geral (Semanal)';

      // KPIs de exemplo
      const kpi = computeKPIs(type, id);
      document.getElementById('kpi-up').textContent = kpi.up+'%';
      document.getElementById('kpi-alert').textContent = kpi.alertas;
      document.getElementById('kpi-cpu').textContent = kpi.cpu+'%';
      document.getElementById('kpi-tickets').textContent = kpi.tickets;

      // Labels e séries pro gráfico semanal
      const labels = ['Hoje','D-1','D-2','D-3','D-4','D-5','D-6'];
      const series = buildSeries(type, id);

      const ctx = document.getElementById('reportChart').getContext('2d');
      if (reportChart){ reportChart.destroy(); } // limpo antes de replotar
      reportChart = new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[
            {label:'CPU (%)',   data:series.cpu,   borderColor:'rgba(10, 203, 227, 1)', backgroundColor:'rgba(10, 203, 227, 0.15)', fill:true, tension:.35, pointRadius:2.5},
            {label:'RAM (%)',   data:series.ram,   borderColor:'rgba(79, 209, 197, 1)', backgroundColor:'rgba(79, 209, 197, 0.15)', fill:true, tension:.35, pointRadius:2.5},
            {label:'Disco (%)', data:series.disco, borderColor:'rgba(255, 92, 92, 1)',  backgroundColor:'rgba(255, 92, 92, 0.12)', fill:true, tension:.35, pointRadius:2.5}
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          interaction:{mode:'index', intersect:false},
          scales:{
            x:{ grid:{color:'rgba(255,255,255,0.10)'}, ticks:{color:'#fff'} },
            y:{ beginAtZero:true, max:100, grid:{color:'rgba(255,255,255,0.10)'}, ticks:{color:'#fff'} }
          },
          plugins:{ legend:{position:'top'} }
        }
      });
    }

    // KPIs de exemplo com variação por id (só pra parecer dados diferentes)
    function computeKPIs(type, id){
      if (type==='dooh'){
        const seed = Array.from(id).reduce((a,c)=>a+c.charCodeAt(0),0)%10;
        return { up: 98-seed, alertas: 2+seed%2, cpu: 54+seed, tickets: 1+seed%3 };
      }
      return { up: 96, alertas: 12, cpu: 58, tickets: 7 };
    }

    // Séries do gráfico depois eu troco por dados reais da API.
    function buildSeries(type, id){
      const base = [40,45,50,55,60,58,57];
      if (type==='dooh'){
        const offset = (Array.from(id).reduce((a,c)=>a+c.charCodeAt(0),0)%7)-3;
        return {
          cpu:   base.map((v,i)=>limit01(v+offset+(i%3?2:0))),
          ram:   base.map((v,i)=>limit01(v-5+offset+(i%2?3:0))),
          disco: base.map((v,i)=>limit01(20+offset+i))
        };
      }
      return {
        cpu:   [48,52,51,57,60,59,58],
        ram:   [50,51,53,55,56,54,53],
        disco: [15,16,17,18,17,16,15]
      };
    }
    function limit01(v){ return Math.max(0, Math.min(100, Math.round(v))); }

    /* ------ Quando mudo a aba das tabelas, aplico o mesmo filtro no mapa ------ */
    const seletorLista = document.getElementById('seletor-lista');
    const blocosList = {
      todos : document.getElementById('lista-todos'),
      risco : document.getElementById('lista-risco'),
      alerta: document.getElementById('lista-alerta'),
      ok    : document.getElementById('lista-ok')
    };
    seletorLista.addEventListener('change', () => {
      const chave = seletorLista.value;
      Object.values(blocosList).forEach(div => div.classList.add('lista-oculta'));
      blocosList[chave].classList.remove('lista-oculta');
      filterStatus(chave);
    });

    /* ------ Inicialização: crio o mapa e carrego os dados ------ */
    document.addEventListener('DOMContentLoaded', function() {
      initMap();
      loadData();
    });

    /* ------ Disponibilizo o filtro do mapa pra usar de fora se precisar ------ */
    window.vizorMap = {
      filterStatus
    };
  })();
  </script>
</body>
</html>

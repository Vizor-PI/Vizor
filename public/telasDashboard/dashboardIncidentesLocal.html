<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Vizor | Dashboard de Incidentes ITIL</title>

  <!-- ESTILOS E BIBLIOTECAS -->
  <link rel="stylesheet" href="../assets/css/css-dashboard/dashboard.css" />
  <link rel="stylesheet" href="../assets/css/css-dashboard/navbar.css" />
  <link rel="icon" href="../assets/imgs/logosDash/home.png" type="image/x-icon" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ESTILOS GERAIS */
    body {
      background-color: #061722;
      color: white;
      font-family: 'Akatab', sans-serif;
      margin: 0;
      padding: 0;
      display: flex; 
      flex-direction: row;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .navbar {
        position: sticky !important; 
        top: 0;
        height: 100vh !important;    
        flex-shrink: 0;              
        z-index: 999;               
        min-width: 250px;            
        display: flex;
        flex-direction: column;
    }

    /* Header Principal */
    .main-header {
        display: flex;
        justify-content: center; 
        align-items: center;
        position: relative;
        margin: 30px 0;
    }
    
    .main-header h1 {
        color: aqua;
        margin: 0;
        text-align: center;
    }

    .header-actions {
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
    }

    .container-xl { 
      flex-grow: 1; 
      padding: 24px; 
      box-sizing: border-box;
      width: 100%; 
      max-width: calc(100vw - 250px); 
      overflow-y: auto;
    }

    /* COMPONENTES VISUAIS */
    .kpi-card {
      background: #072135;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .kpi-row-4 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .kpi-label { color: aqua; font-weight: 600; margin-bottom: 4px; }
    .kpi-value { font-size: 32px; font-weight: 800; }
    .kpi-sub { opacity: 0.8; font-size: 13px; }

    .card {
      background-color: #072135;
      border-radius: 16px;
      color: white;
      padding: 16px;
      box-sizing: border-box;
      margin-bottom: 24px;
    }
    .card-header { margin-bottom: 12px; }
    .card-title { color: aqua; font-weight: 700; font-size: 1.4rem; }

    .alert-top-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .alert-kpi {
      background: #0f1f2b;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 12px 16px;
      min-height: 110px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: #fff;
    }
    .alert-kpi .head {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sev-dot { width: 10px; height: 10px; border-radius: 999px; }
    .sev-dot.critico { background: #e74c3c; box-shadow: 0 0 10px #e74c3c55; }
    .sev-dot.alerta { background: #f39c12; box-shadow: 0 0 10px #f39c1255; }
    .sev-dot.info { background: #3498db; box-shadow: 0 0 10px #3498db55; }
    
    .alert-kpi .value { font-size: 28px; font-weight: 700; line-height: 1.2; }
    .alert-kpi .desc { font-size: 12px; opacity: .75; }

    .alerts-header {
      display: flex; flex-wrap: wrap; justify-content: space-between;
      align-items: flex-start; gap: 16px; margin-bottom: 16px;
    }
    .alerts-header-right { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 12px; opacity: .8; }
    .ui-select {
      background: #0f1f2b; border: 1px solid rgba(255,255,255,.15);
      color: #fff; border-radius: 8px; padding: 8px 10px; min-width: 140px;
    }

    .alert-list { display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
    .alert-list::-webkit-scrollbar { width: 6px; }
    .alert-list::-webkit-scrollbar-track { background: #0e1117; }
    .alert-list::-webkit-scrollbar-thumb { background: #00bcd4; border-radius: 4px; }

    .alert-card {
      background: #0f1f2b;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 12px 16px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      color: #fff;
      transition: transform 0.2s;
    }
    .alert-card:hover { transform: translateX(4px); border-color: rgba(255,255,255,.2); }

    .alert-main { font-size: 13px; line-height: 1.4; }
    .alert-headline { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
    .alert-title { font-size: 14px; font-weight: 600; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    
    .alert-status-badge {
      font-size: 11px; font-weight: 600; border-radius: 999px; padding: 2px 8px;
      display: inline-block; white-space: nowrap; text-transform: uppercase;
    }
    .alert-status-badge.critico { background: #ffe6e6; color: #a40000; }
    .alert-status-badge.alerta { background: #fff8e6; color: #a66300; }
    .alert-status-badge.info { background: #e6f1ff; color: #004a99; }

    .alert-time { opacity: .7; font-size: 12px; }
    .alert-subinfo { font-size: 12px; opacity: .9; margin-bottom: 8px; }
    
    .alert-meta-grid {
      margin-top: 8px; display: flex; flex-wrap: wrap; gap: 12px;
      font-size: 12px; opacity: .8; background: rgba(0,0,0,0.2);
      padding: 6px; border-radius: 6px;
    }

    .alert-aside {
      min-width: 140px; font-size: 12px; display: flex;
      flex-direction: column; justify-content: center; text-align: right;
    }
    .alert-action { margin-top: 8px; color: aqua; font-weight: 600; }

    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .chart-box { height: 350px; }
    #vizor-map { width: 100%; height: 420px; border-radius: 12px; }

    .vizor-btn {
        background: #00bcd4; 
        color: #000; 
        border: none; 
        padding: 8px 16px; 
        border-radius: 4px; 
        cursor: pointer; 
        font-weight: bold;
        transition: background 0.3s;
    }
    .vizor-btn:hover { background: #00acc1; }

    /* MODAL */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 1000; display: none;
        justify-content: center; align-items: center;
    }
    .modal-content {
        background: #072135; padding: 24px; border-radius: 12px;
        border: 1px solid #00bcd4; width: 90%; max-width: 600px;
        color: white;
    }

    @media(max-width:700px){
      body { flex-direction: column; }
      .navbar { height: auto !important; position: relative !important; width: 100%; }
      .container-xl { max-width: 100%; }
      .alert-card { grid-template-columns: 1fr; text-align: left; }
      .alert-aside { text-align: left; justify-content: flex-start; margin-top: 8px; }
      .main-header { flex-direction: column; gap: 16px; }
      .header-actions { position: static; transform: none; }
    }
  </style>
</head>

<body>
    
    <nav class="navbar" id="navbarConstructor"></nav>

    <main class="container-xl">
    
        <!-- HEADER PRINCIPAL COM BOTÃO DE RELATÓRIO -->
        <div class="main-header">
            <h1>Dashboard de Incidentes - ITIL</h1>
            <div class="header-actions">
                <button id="btn-open-report" class="vizor-btn">Gerar Relatório</button>
            </div>
        </div>

        <!-- KPIs GERAIS -->
        <section class="card kpi-card">
            <header class="card-header">
                <h2 class="card-title">Status Geral dos Chamados (Jira)</h2>
            </header>
            
            <div class="vizor-filter" style="padding-left: 22px; padding-top: 10px;">
                <label for="periodo" style="font-size: 0.9rem; color: #ccc;">Período:</label>
                <select id="periodo" class="vizor-select" style="background:#0e1117; color:white; border:1px solid #00bcd4; border-radius:6px; padding:4px 8px;">
                <option value="24h">Últimas 24h</option>
                <option value="7d" selected>Última semana</option>
                <option value="30d">Último mês</option>
                </select>
            </div>

            <div class="card-content">
                <div class="kpi-row-4">
                <div><h4 class="kpi-label">Abertos</h4><p class="kpi-value" id="kpi-incidentes-abertos">--</p><p class="kpi-sub">Em andamento</p></div>
                <div><h4 class="kpi-label">Fechados</h4><p class="kpi-value" id="kpi-incidentes-fechados">--</p><p class="kpi-sub">Total resolvido</p></div>
                <div><h4 class="kpi-label">Tempo médio</h4><p class="kpi-value" id="kpi-tempo-resolucao">--</p><p class="kpi-sub">para resolução</p></div>
                <div><h4 class="kpi-label">SLA Cumprido</h4><p class="kpi-value" id="kpi-sla">--</p><p class="kpi-sub">No prazo</p></div>
                </div>
            </div>
        </section>

        <!-- ALERTAS S3 -->
        <section class="alert-top-grid">
            <div class="alert-kpi">
                <div class="head"><span class="sev-dot critico"></span><span>Alertas Críticos</span></div>
                <div class="value" id="kpi-criticos">0</div>
                <div class="desc">Falhas graves de hardware/rede.</div>
            </div>
            <div class="alert-kpi">
                <div class="head"><span class="sev-dot alerta"></span><span>Em Atenção</span></div>
                <div class="value" id="kpi-alertas">0</div>
                <div class="desc">Sobrecarga ou aquecimento.</div>
            </div>
            <div class="alert-kpi">
                <div class="head"><span class="sev-dot info"></span><span>Infos</span></div>
                <div class="value" id="kpi-infos">0</div>
                <div class="desc">Monitoramento regular.</div>
            </div>
        </section>

        <section class="card">
            <div class="alerts-header">
                <div class="alerts-header-left">
                <h2 class="card-title">Alertas de Hardware (Tempo Real)</h2>
                <small>Dados lidos da pasta local (simulando S3)</small>
                </div>
                <div class="alerts-header-right">
                <div class="filter-group">
                    <label for="filtro-severidade">Severidade</label>
                    <select id="filtro-severidade" class="ui-select">
                    <option value="todos" selected>Todos</option>
                    <option value="CRITICO">Crítico</option>
                    <option value="ALERTA">Alerta</option>
                    <option value="INFO">Info</option>
                    </select>
                </div>
                </div>
            </div>

            <div class="alert-list" id="alert-list">
                <p style="text-align: center; color: #888; padding: 20px;">Carregando dados...</p>
            </div>
        </section>

        <!-- GRÁFICOS -->
        <section class="grid-2">
            <div class="card">
                <header class="card-header"><h2 class="card-title">Incidentes por Área</h2></header>
                <div class="card-content"><div class="chart-box"><canvas id="chartIncidentesArea"></canvas></div></div>
            </div>
            <div class="card">
                <header class="card-header"><h2 class="card-title">Tendência Semanal</h2></header>
                <div class="card-content"><div class="chart-box"><canvas id="chartTendenciaIncidentes"></canvas></div></div>
            </div>
        </section>

        <section class="card" style="padding:16px; margin-bottom:16px;">
            <header class="card-header"><h2 class="card-title">Distribuição Geografica dos Incidentes</h2><small style="opacity:.7;">Distribuição geográfica</small></header>
            <div id="vizor-map"></div>
        </section>

        <!-- 
            MODAL DE RELATÓRIO
        -->
        <div id="modal-relatorio" class="modal-overlay">
            <div class="modal-content">
                <div id="step-selector">
                    <h2 style="margin-top:0; color:aqua;">Gerar Relatório Completo</h2>
                    <p>Este relatório irá capturar o estado atual da Dashboard (KPIs, Gráficos, Alertas e Mapa) e exportar para PDF.</p>
                    
                    <div style="margin-bottom: 16px;">
                        <label class="vizor-label">Período de Referência:</label><br>
                        <div style="margin-top: 8px; display: flex; gap: 15px;">
                            <label class="vizor-radio"><input type="radio" name="report-type" value="semanal" checked> Semanal</label>
                            <label class="vizor-radio"><input type="radio" name="report-type" value="mensal"> Mensal</label>
                        </div>
                    </div>

                    <div style="text-align: right; margin-top: 20px;">
                        <button id="btn-cancel-report" class="vizor-btn" style="background: transparent; border: 1px solid #00bcd4; color: #00bcd4; margin-right: 10px;">Cancelar</button>
                        <button id="btn-print-report" class="vizor-btn">Baixar PDF</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

  <!-- SCRIPTS -->
  <script src="../js/navbar.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // URL do Backend (Ajustado para localhost padrão do Node)
    const API_BASE_URL = "/api/jira"; 
    
    // Variáveis globais de estado
    let globalAvisos = []; 
    let map; 
    let markersLayer = new L.LayerGroup(); 
    let dadosKpiCache = { aberto: 0, fechado: 0, tempoMedio: 0, sla: 0 };
    let listaMaquinasCache = new Set(); 

    document.addEventListener("DOMContentLoaded", () => {
      inicializarMapa(); 
      atualizarKPIsJira(); // Chama API
      processarAvisos();   // Lê arquivos locais
      gerarGraficos();     // Chama API
    });

    // ================= FUNÇÕES DO MAPA =================
    function inicializarMapa() {
      map = L.map('vizor-map').setView([-23.5614, -46.6559], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
        attribution: '&copy; OpenStreetMap' 
      }).addTo(map);
      markersLayer.addTo(map);
    }
    
    function renderizarMapa() {
      markersLayer.clearLayers(); 
      globalAvisos.forEach(aviso => {
        if (aviso.raw_metrics.latitude && aviso.raw_metrics.longitude) {
            const lat = aviso.raw_metrics.latitude;
            const long = aviso.raw_metrics.longitude;
            const severidade = aviso.ui.severity;
            const mensagem = aviso.ui.message;

            let corCirculo = '#3498db'; 
            let raio = 8; 

            if (severidade === "CRITICO") {
                corCirculo = '#e74c3c'; 
                raio = 14; 
            } else if (severidade === "ALERTA") {
                corCirculo = '#f39c12'; 
                raio = 11;
            }
            
            const marcador = L.circleMarker([lat, long], {
                radius: raio,
                fillColor: corCirculo,
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            const popupContent = `
                <div style="color:black;">
                    <strong>Máquina ID:</strong> ${aviso.machine_id}<br>
                    <strong>Situação:</strong> <span style="font-weight:bold; color: ${corCirculo};">${severidade}</span><br>
                    <strong>Problema:</strong> ${mensagem}<br>
                    <strong>Temp/CPU/Disco:</strong> ${aviso.raw_metrics.temp}°C / ${aviso.raw_metrics.cpu}% / ${aviso.raw_metrics.disco}%
                </div>
            `;
            marcador.bindPopup(popupContent);
            markersLayer.addLayer(marcador);
        }
      });
      
      if (markersLayer.getLayers().length > 0) {
           try { map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] }); } catch(e) {}
      }
    }

    // ================= FUNÇÕES DO JIRA (KPIs - REAIS) =================
    async function atualizarKPIsJira() {
      try {
        // Chamada real ao backend
        const response = await fetch(`${API_BASE_URL}/metricas`);
        if(!response.ok) throw new Error("Erro ao buscar KPIs do Jira");
        
        const dados = await response.json();
        dadosKpiCache = dados; 
        
        document.getElementById("kpi-incidentes-abertos").textContent = dados.aberto;
        document.getElementById("kpi-incidentes-fechados").textContent = dados.fechado;
        document.getElementById("kpi-tempo-resolucao").textContent = dados.tempoMedio + "h";
        document.getElementById("kpi-sla").textContent = dados.sla + "%";
      } catch (err) { 
          console.error("Erro KPIs Jira:", err);
          // Fallback visual
          document.getElementById("kpi-incidentes-abertos").textContent = "-";
      }
    }

    // ================= FUNÇÕES DE ALERTAS (S3 LOCAL) =================
    async function processarAvisos() {
      try {
        // Caminho relativo da pasta onde estão os JSONs
        // Se o HTML estiver em 'site/dashboard.html', e vizor-client em 'site/vizor-client', use './vizor-client'
        const BASE_PATH = "/vizor-client/aquino-client/Tech_Solutions"; 
        
        const maquinas = ['COD001', 'COD002', 'COD003'];
        
        const promises = maquinas.map(async (cod) => {
            try {
                const res = await fetch(`${BASE_PATH}/${cod}.json`);
                if (!res.ok) throw new Error("Erro fetch");
                return await res.json();
            } catch (e) {
                console.warn(`Não achou ${cod} localmente, usando mock.`);
                return getMockData(cod);
            }
        });

        const resultados = await Promise.all(promises);
        globalAvisos = resultados.filter(item => item !== null);
        
        // Calcula Totais
        const criticos = globalAvisos.filter(a => a.ui.severity === "CRITICO").length;
        const alertas = globalAvisos.filter(a => a.ui.severity === "ALERTA").length;
        const infos = globalAvisos.filter(a => a.ui.severity === "INFO").length;

        document.getElementById("kpi-criticos").textContent = criticos;
        document.getElementById("kpi-alertas").textContent = alertas;
        document.getElementById("kpi-infos").textContent = infos;

        renderizarListaAvisos();
        renderizarMapa(); 
      } catch (err) {
        console.error("Erro Geral", err);
      }
    }

    function getMockData(cod) {
        // JSON aqui caso o arquivo local não carregue (por segurança)
        if(cod === 'COD001') return {
             "machine_id": "COD001", "company": "Tech_Solutions", "last_update": "02/12/2025 14:10",
             "raw_metrics": { "cpu": "96.5%", "ram": "65.0%", "disco": "81.4%", "temp": "82.0°C", "latitude": -23.55052, "longitude": -46.633308 },
             "ui": { "severity": "CRITICO", "color": "red", "title": "Falha Crítica", "message": "CPU Alto", "action": "Reboot" }
        };
        if(cod === 'COD002') return {
             "machine_id": "COD002", "company": "Tech_Solutions", "last_update": "02/12/2025 14:15",
             "raw_metrics": { "cpu": "72.0%", "ram": "45.0%", "disco": "60.3%", "temp": "74.0°C", "latitude": -23.55052, "longitude": -46.633308 },
             "ui": { "severity": "ALERTA", "color": "yellow", "title": "Atenção", "message": "Hardware instável", "action": "Verificar" }
        };
        return {
             "machine_id": "COD003", "company": "Tech_Solutions", "last_update": "02/12/2025 14:20",
             "raw_metrics": { "cpu": "45.2%", "ram": "55.0%", "disco": "50.0%", "temp": "58.0°C", "latitude": -23.55052, "longitude": -46.633308 },
             "ui": { "severity": "INFO", "color": "green", "title": "Normal", "message": "Monitorando", "action": "Nenhuma" }
        };
    }

    function renderizarListaAvisos() {
        const container = document.getElementById("alert-list");
        container.innerHTML = "";
        const filtroSev = document.getElementById("filtro-severidade").value;
        
        const filtrados = globalAvisos.filter(a => {
            return filtroSev === "todos" || a.ui.severity === filtroSev;
        });

        if (filtrados.length === 0) {
            container.innerHTML = "<p style='text-align:center; opacity:0.7; padding:20px;'>Nenhum aviso encontrado.</p>";
            return;
        }

        filtrados.forEach(aviso => {
            let sevClass = "info";
            if (aviso.ui.severity === "CRITICO") sevClass = "critico";
            if (aviso.ui.severity === "ALERTA") sevClass = "alerta";

            const card = document.createElement("div");
            card.className = "alert-card";
            card.innerHTML = `
                <div class="alert-main">
                    <div class="alert-headline">
                        <div class="alert-title">
                            <span>${aviso.machine_id}</span>
                            <span class="alert-status-badge ${sevClass}">${aviso.ui.severity}</span>
                        </div>
                        <div class="alert-time">${aviso.last_update}</div>
                    </div>
                    <div class="alert-subinfo">
                        <strong>${aviso.ui.title}</strong><br/>
                        ${aviso.ui.message}
                    </div>
                    <div class="alert-meta-grid">
                        <span>CPU ${aviso.raw_metrics.cpu}</span>
                        <span>Temp ${aviso.raw_metrics.temp}</span>
                        <span>RAM ${aviso.raw_metrics.ram}</span>
                        <span>Disco ${aviso.raw_metrics.disco}</span>
                    </div>
                </div>
                <aside class="alert-aside">
                    <div class="alert-action">
                        <strong>Ação:</strong>
                        ${aviso.ui.action}
                    </div>
                </aside>
            `;
            container.appendChild(card);
        });
    }
    document.getElementById("filtro-severidade").addEventListener("change", renderizarListaAvisos);

    // ================= GRÁFICOS (REAIS - API) =================
    async function gerarGraficos() {
      try {
        // Chamada real ao backend
        const resposta = await fetch(`${API_BASE_URL}/issues`);
        if(!resposta.ok) throw new Error("Erro ao buscar Issues do Jira");
        
        const listaChamados = await resposta.json();

        let totalInfra = 0; let totalApps = 0; let totalRede = 0; let totalSeguranca = 0; let totalBanco = 0;

        listaChamados.forEach(chamado => {
            if (chamado.fields && chamado.fields.labels && chamado.fields.labels.length > 0) {
                const etiquetas = chamado.fields.labels;
                if (etiquetas.includes("infraestrutura")) totalInfra++;
                else if (etiquetas.includes("aplicacoes")) totalApps++;
                else if (etiquetas.includes("rede")) totalRede++;
                else if (etiquetas.includes("seguranca")) totalSeguranca++;
                else if (etiquetas.includes("banco_de_dados")) totalBanco++;
                else totalInfra++;
            } else { totalInfra++; }
        });

        const ctxArea = document.getElementById('chartIncidentesArea').getContext('2d');
        new Chart(ctxArea, {
          type: 'bar',
          data: {
            labels: ['Infraestrutura', 'Aplicações', 'Rede', 'Segurança', 'Banco de Dados'],
            datasets: [{
              label: 'Quantidade de Incidentes',
              data: [totalInfra, totalApps, totalRede, totalSeguranca, totalBanco],
              backgroundColor: 'rgba(10, 203, 227, 0.6)',
              borderColor: 'rgba(10, 203, 227, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } } },
            plugins: { legend: { display: false } }
          }
        });

        let contagemSemanal = [0, 0, 0, 0, 0, 0, 0]; 
        const hoje = new Date();
        const seteDiasAtras = new Date();
        seteDiasAtras.setDate(hoje.getDate() - 7);
        
        // Contador de incidentes reais
        let incidentesRecentes = 0;

        listaChamados.forEach(chamado => {
            if (chamado.fields && chamado.fields.created) {
                const dataCriacao = new Date(chamado.fields.created);
                if (dataCriacao >= seteDiasAtras) {
                    const diaDaSemana = dataCriacao.getDay(); 
                    contagemSemanal[diaDaSemana]++;
                    incidentesRecentes++;
                }
            }
        });
        
        // Se não houver incidentes reais, use Mock para o gráfico não ficar vazio
        console.log("Incidentes recentes:", incidentesRecentes);
        if(incidentesRecentes === 0) {
             console.log("Usando Mock para gráfico semanal");
             contagemSemanal = [2, 5, 3, 6, 4, 7, 2];
        }

        const ctxTrend = document.getElementById('chartTendenciaIncidentes').getContext('2d');
        new Chart(ctxTrend, {
          type: 'line',
          data: {
            labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
            datasets: [{
              label: 'Novos Incidentes (Últimos 7 dias)',
              data: contagemSemanal,
              borderColor: '#ff5c5c',
              backgroundColor: 'rgba(255, 92, 92, 0.2)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { beginAtZero: true, ticks: { stepSize: 1, color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } } },
            plugins: { legend: { labels: { color: '#fff' } } }
          }
        });
      } catch (erro) { console.error("Erro ao gerar gráficos:", erro); }
    }

    // ================= LÓGICA DO RELATÓRIO COMPLETO =================
    const modal = document.getElementById("modal-relatorio");

    document.getElementById("btn-open-report").onclick = () => {
        modal.style.display = "flex";
    };

    document.getElementById("btn-cancel-report").onclick = () => { 
        modal.style.display = "none"; 
    };

    document.getElementById("btn-print-report").onclick = async () => {
        const { jsPDF } = window.jspdf;
        modal.style.display = "none";
        const element = document.querySelector("main.container-xl");
        await new Promise(r => setTimeout(r, 300));
        
        try {
            const canvas = await html2canvas(element, { 
                scale: 1.5, 
                backgroundColor: "#061722", 
                useCORS: true, 
                logging: false
            });
            
            const imgData = canvas.toDataURL("image/png");
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfW = pdf.internal.pageSize.getWidth();
            const imgProps = pdf.getImageProperties(imgData);
            const imgH = (imgProps.height * pdfW) / imgProps.width;
            
            pdf.setTextColor(20, 200, 200);
            pdf.setFontSize(12);
            pdf.text("Relatório de Status - Vizor", 10, 10);
            pdf.addImage(imgData, 'PNG', 0, 15, pdfW, imgH);
            pdf.save("Relatorio_Vizor_Completo.pdf");
        } catch (e) {
            console.error("Erro PDF", e);
            alert("Erro ao gerar PDF");
        }
    };

    function limparSessao() { sessionStorage.clear(); }
  </script>
</body>
</html>
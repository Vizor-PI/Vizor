<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vizor — Suporte à Manutenção</title>

  <!-- Links Originais do seu Projeto -->
  <link rel="stylesheet" href="../assets/css/css-dashboard/pedroDash.css" />
  <link rel="stylesheet" href="../assets/css/css-dashboard/navbar.css" />
  <link rel="icon" href="../assets/imgs/logosDash/home.png" type="image/x-icon" />

  <!-- Fonte Akatab -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Akatab:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <!-- Lucide Icons & ApexCharts -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

 
</head>
<body onload="verificarCargo()"> 

  <!-- Navbar -->
  <nav class="navbar" id="navbarConstructor"></nav>

  <!-- Conteúdo -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">Dashboard de Manutenção</h1>
      <span class="page-sub">Visão geral do parque de dispositivos DOOH</span>
    </div>

    <!-- KPIs -->
    <section class="kpi-grid">
      <div class="card"><div class="card-header"><h2 class="card-title"><i data-lucide="shield-check" size="18" style="color:aqua"></i> Condição dos DOOHs</h2></div><div class="card-content"><div class="kpi-row"><div class="kpi-item"><div class="kpi-label">Players</div><div class="kpi-value" id="kpi-total">0</div></div><div class="kpi-item"><div class="kpi-label" style="color:#e74c3c">Crítico</div><div class="kpi-value" id="kpi-critico" style="color:#e74c3c">0</div></div><div class="kpi-item"><div class="kpi-label" style="color:#f1c40f">Alerta</div><div class="kpi-value" id="kpi-alerta" style="color:#f1c40f">0</div></div><div class="kpi-item"><div class="kpi-label" style="color:#2ecc71">OK</div><div class="kpi-value" id="kpi-ok" style="color:#2ecc71">0</div></div></div></div></div>
      <div class="card"><div class="card-header"><h2 class="card-title"><i data-lucide="cpu" size="18" style="color:aqua"></i> Hardware (Mediana 24h)</h2></div><div class="card-content"><div class="kpi-row"><div class="kpi-item"><div class="kpi-label">CPU</div><div class="kpi-value" style="color:aqua" id="kpi-cpu-med">0%</div></div><div class="kpi-item"><div class="kpi-label">RAM</div><div class="kpi-value" style="color:#a29bfe" id="kpi-ram-med">0%</div></div><div class="kpi-item"><div class="kpi-label">Disco</div><div class="kpi-value" style="color:#ff7675" id="kpi-disk-med">0%</div></div><div class="kpi-item"><div class="kpi-label">Temp</div><div class="kpi-value" style="color:#fdcb6e" id="kpi-temp-med">0°C</div></div></div></div></div>
    </section>

    <!-- Mapa -->
    <section class="card map-container">
      <div class="map-controls">
        <i data-lucide="search" size="16" style="color:rgba(255,255,255,0.5);"></i>
        <input type="text" id="search-dooh" class="vizor-input" placeholder="Buscar DOOH..." style="width:160px; background:transparent; border:none; padding-left:8px;">
        <div style="width:1px; height:20px; background:rgba(255,255,255,0.1); margin:0 8px;"></div>
        <select id="filter-status" class="vizor-select" style="background:transparent; border:none;">
          <option value="todos">Status: Todos</option>
          <option value="critico">Crítico (Falha)</option>
          <option value="alerta">Alerta (Atenção)</option>
          <option value="ok">OK (Normal)</option>
        </select>
        <div style="width:1px; height:20px; background:rgba(255,255,255,0.1); margin:0 8px;"></div>
        <button class="vizor-btn" id="btn-reset-map" style="padding:6px 12px; font-size:12px; border:1px solid rgba(255,255,255,0.1);">Limpar</button>
      </div>
      <div id="vizor-map"></div>
    </section>

    <!-- Lista -->
    <section class="card">
      <div class="card-header">
        <h2 class="card-title"><i data-lucide="list" size="18" style="color:aqua"></i> Lista de Dispositivos</h2>
        <div class="card-subtitle" style="margin:0; font-size:12px; color:rgba(255,255,255,0.5);">Total visível: <span id="list-count">0</span></div>
      </div>
      <div class="card-content">
        <div class="device-grid" id="device-list"></div>
      </div>
    </section>
  </main>

  <!-- MODAL (Overlay) -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="vizor-modal">
      <div class="modal-header">
        <div class="modal-title-group">
          <h3 id="modal-title">...</h3>
          <div class="modal-subtitle"><i data-lucide="map-pin" size="12"></i> <span id="modal-loc">...</span></div>
        </div>
      
      </div>

      <div class="modal-body">
        
        <!-- Predição -->
        <div class="pred-title"><i data-lucide="activity" size="16" style="color:aqua"></i> Análise Preditiva (Regressão Linear)</div>
        
        <div class="prediction-section">
          <div class="pred-left">
            <div class="risk-label">Probabilidade de Falha (24h)</div>
            <div class="risk-percent" id="modal-prob" style="color:#fff">0%</div>
            <div class="risk-label" style="margin-top:-4px;">risco calculado</div>
            <div class="progress-bg"><div class="progress-fill" id="modal-prog"></div></div>
          </div>
          <div class="pred-right">
            <div class="cause-box">
              <div class="cause-label">Principal Causa Provável</div>
              <div class="cause-text"><i data-lucide="alert-triangle" size="14" style="color:#f1c40f"></i> <span id="modal-cause">...</span></div>
            </div>
            <div class="cause-box" style="margin-top:12px;">
              <div class="cause-label">Recomendação Sugerida</div>
              <div class="rec-text"><i data-lucide="wrench" size="14"></i> <span id="modal-rec">...</span></div>
            </div>
          </div>
        </div>

        <!-- Métricas -->
        <div class="m-label">MÉTRICAS ATUAIS (MEDIANAS)</div>
        <div class="metrics-grid">
          <div class="metric-card"><div class="mc-title">CPU</div><div class="mc-val" style="color:aqua" id="modal-cpu">0%</div></div>
          <div class="metric-card"><div class="mc-title">Memória</div><div class="mc-val" style="color:#a29bfe" id="modal-ram">0%</div></div>
          <div class="metric-card"><div class="mc-title">Temperatura</div><div class="mc-val" style="color:#fdcb6e" id="modal-temp">0°C</div></div>
          <div class="metric-card"><div class="mc-title">Disco</div><div class="mc-val" style="color:#ff7675" id="modal-disk">0%</div></div>
        </div>

        <div class="footer-row">
          <div class="info-pill"><span>Uptime</span> <strong id="modal-uptime">0h</strong></div>
          <div class="info-pill"><span>Latência (Ping)</span> <strong id="modal-ping">0ms</strong></div>
        </div>

        <!-- GRÁFICOS HISTÓRICOS (Hidden) -->
        <div id="charts-container" class="charts-container">
           <div class="charts-title"><i data-lucide="bar-chart-2" size="16"></i> Histórico (Últimos 7 Dias)</div>
           <div class="charts-grid">
              <div class="chart-box">
                 <div class="chart-label">CPU (%)</div>
                 <div id="chart-cpu-div" class="chart-render"></div>
              </div>
              <div class="chart-box">
                 <div class="chart-label">Temperatura (°C)</div>
                 <div id="chart-temp-div" class="chart-render"></div>
              </div>
              <div class="chart-box">
                 <div class="chart-label">RAM (%)</div>
                 <div id="chart-ram-div" class="chart-render"></div>
              </div>
              <div class="chart-box">
                 <div class="chart-label">Disco (%)</div>
                 <div id="chart-disk-div" class="chart-render"></div>
              </div>
           </div>
        </div>

        <div class="modal-actions">
          <button class="btn-vizor" onclick="window.toggleCharts()">
             <i data-lucide="bar-chart-2" size="16"></i> Ver Histórico
          </button>
          <button class="btn-vizor btn-primary" onclick="window.closeModal()">Fechar</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../js/verificadorCargo.js"></script>
  <script src="../js/navbar.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <script>
    // Inicializa Ícones
    lucide.createIcons();

    let allDevices = [], mapInstance = null, markersLayer = null;
    let chartInstances = {}; 
    let currentDevice = null;

    // Funções Globais para HTML acessar
    window.closeModal = function() {
      document.getElementById('modal-overlay').style.display = 'none';
    }

    window.toggleCharts = function() {
      const container = document.getElementById('charts-container');
      const isHidden = container.style.display === 'none' || container.style.display === '';
      if (isHidden) {
        container.style.display = 'block';
        setTimeout(() => initCharts(currentDevice), 50); // Delay para renderizar
      } else {
        container.style.display = 'none';
      }
    }

    // Mock de Dados
    async function fetchDados() {
      try {
        // SIMULAÇÃO DE API
        return [
            { id: "DOOH-SP-P001", location: "Av. Paulista, 1000", lat: -23.561, lng: -46.656, status: "ok", cpu: 45, ram: 60, disk: 30, temp: 55, uptime: 120, ping: 20 },
            { id: "DOOH-SP-P002", location: "Metrô Consolação", lat: -23.558, lng: -46.660, status: "critico", cpu: 95, ram: 80, disk: 92, temp: 85, uptime: 10, ping: 120 },
            { id: "DOOH-SP-P003", location: "Shopping Cidade SP", lat: -23.564, lng: -46.652, status: "alerta", cpu: 78, ram: 70, disk: 50, temp: 76, uptime: 48, ping: 45 },
            { id: "DOOH-SP-P004", location: "MASP", lat: -23.562, lng: -46.657, status: "ok", cpu: 50, ram: 55, disk: 40, temp: 60, uptime: 200, ping: 25 },
            { id: "DOOH-SP-P005", location: "Rua Augusta", lat: -23.555, lng: -46.663, status: "ok", cpu: 30, ram: 40, disk: 25, temp: 45, uptime: 350, ping: 15 },
            { id: "DOOH-SP-P006", location: "Hospital das Clínicas", lat: -23.556, lng: -46.668, status: "alerta", cpu: 82, ram: 65, disk: 70, temp: 78, uptime: 24, ping: 60 },
            { id: "DOOH-SP-P007", location: "Parque Trianon", lat: -23.563, lng: -46.658, status: "ok", cpu: 40, ram: 50, disk: 35, temp: 50, uptime: 150, ping: 18 },
            { id: "DOOH-SP-P008", location: "Centro Cultural SP", lat: -23.572, lng: -46.641, status: "critico", cpu: 98, ram: 90, disk: 85, temp: 92, uptime: 2, ping: 200 },
            { id: "DOOH-SP-P009", location: "Av. Brigadeiro", lat: -23.568, lng: -46.648, status: "ok", cpu: 25, ram: 35, disk: 20, temp: 40, uptime: 500, ping: 10 },
            { id: "DOOH-SP-P010", location: "Metrô Paraíso", lat: -23.576, lng: -46.646, status: "ok", cpu: 55, ram: 60, disk: 45, temp: 58, uptime: 100, ping: 22 }
        ];
      } catch (e) { console.error(e); return []; }
    }

    // Lógica
    function calculatePrediction(d) {
      const riskScore = (d.temp * 0.5) + (d.cpu * 0.3) + (d.disk * 0.2);
      let prob = Math.min(99, Math.floor(riskScore));
      let cause = 'Desgaste Natural', rec = 'Manutenção Preventiva Padrão', riskLevel = 'low';
      if (d.status === 'critico' || prob > 80) {
        riskLevel = 'high';
        if (d.disk > 90) { cause = 'Falha de Disco I/O'; rec = 'Substituição de SSD Iminente'; }
        else if (d.temp > 80) { cause = 'Sobrecarga Térmica'; rec = 'Verificar ventoinhas e arrefecimento'; }
        else { cause = 'Falha Crítica de Sistema'; rec = 'Reiniciar e analisar logs'; }
      } else if (d.status === 'alerta' || prob > 60) {
        riskLevel = 'medium'; cause = 'Carga Elevada'; rec = 'Monitorar processos em background';
      }
      return { prob, cause, rec, riskLevel };
    }

    function getMedian(values) {
      if(!values.length) return 0;
      values.sort((a,b)=>a-b);
      const mid = Math.floor(values.length/2);
      return values.length%2 ? values[mid] : (values[mid-1]+values[mid])/2;
    }

    function updateStats(list) {
      document.getElementById('list-count').textContent = list.length;
      document.getElementById('kpi-total').textContent = list.length;
      document.getElementById('kpi-critico').textContent = list.filter(d=>d.status==='critico').length;
      document.getElementById('kpi-alerta').textContent = list.filter(d=>d.status==='alerta').length;
      document.getElementById('kpi-ok').textContent = list.filter(d=>d.status==='ok').length;
      if (list.length > 0) {
         const m = (arr) => arr.sort((a,b)=>a-b)[Math.floor(arr.length/2)];
         document.getElementById('kpi-cpu-med').textContent = Math.floor(m(list.map(d=>d.cpu)))+'%';
         document.getElementById('kpi-ram-med').textContent = Math.floor(m(list.map(d=>d.ram)))+'%';
         document.getElementById('kpi-temp-med').textContent = Math.floor(m(list.map(d=>d.temp)))+'°C';
         document.getElementById('kpi-disk-med').textContent = Math.floor(m(list.map(d=>d.disk)))+'%';
      }
    }

    // Renderização
    function initMap() {
      mapInstance = L.map('vizor-map', { zoomControl: false }).setView([-23.56, -46.65], 13);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap', maxZoom: 19 }).addTo(mapInstance);
      L.control.zoom({ position: 'bottomright' }).addTo(mapInstance);
      markersLayer = L.layerGroup().addTo(mapInstance);
    }

    function renderMap(list) {
      markersLayer.clearLayers();
      list.forEach(d => {
        let color = d.status === 'critico' ? '#e74c3c' : (d.status === 'alerta' ? '#f1c40f' : '#2ecc71');
        const marker = L.circleMarker([d.lat, d.lng], { radius: 8, fillColor: color, color: '#fff', weight: 2, opacity: 1, fillOpacity: 1 });
        marker.on('click', () => { mapInstance.flyTo([d.lat, d.lng], 17, { duration: 1.5 }); openModal(d); });
        marker.bindTooltip(`<b>${d.id}</b>`, { direction: 'top', offset: [0, -10] });
        marker.addTo(markersLayer);
      });
    }

    function renderList(list) {
      const container = document.getElementById('device-list');
      container.innerHTML = '';
      const sorted = [...list].sort((a,b) => (a.status==='critico'?0:1) - (b.status==='critico'?0:1));
      sorted.forEach(d => {
        const el = document.createElement('div');
        el.className = 'device-item';
        el.onclick = () => { mapInstance.flyTo([d.lat, d.lng], 17, { duration: 1.5 }); openModal(d); };
        let stLabel = d.status === 'critico' ? 'CRITICAL' : (d.status === 'alerta' ? 'WARNING' : 'OK');
        let hlMetric = '', hlColor = '#fff';
        if(d.status==='critico') { hlMetric = `Disco (${d.disk}%)`; hlColor='#e74c3c'; }
        else if(d.status==='alerta') { hlMetric = `Temp (${d.temp}°C)`; hlColor='#f1c40f'; }
        else { hlMetric = `Ping: ${d.ping}ms`; hlColor='#2ecc71'; }
        let badgeClass = d.status;
        el.innerHTML = `<div class="device-head"><div class="device-name">${d.id}</div><span class="badge ${badgeClass}">${stLabel}</span></div><div class="device-loc"><i data-lucide="map-pin" size="12"></i> ${d.location}</div><div class="device-stats"><span style="color:rgba(255,255,255,0.5)">Uptime: ${d.uptime}h</span><span class="hl-metric" style="color:${hlColor}">${hlMetric}</span></div>`;
        container.appendChild(el);
      });
      lucide.createIcons();
    }

    function applyFilters() {
      const term = document.getElementById('search-dooh').value.toLowerCase();
      const st = document.getElementById('filter-status').value;
      const filtered = allDevices.filter(d => d.id.toLowerCase().includes(term) && (st==='todos' || d.status===st));
      renderMap(filtered);
      renderList(filtered);
      if(filtered.length === 1) {
         mapInstance.flyTo([filtered[0].lat, filtered[0].lng], 18, { duration: 1.5 });
         openModal(filtered[0]);
      } else if (filtered.length > 1) {
         const group = L.featureGroup(filtered.map(d => L.circleMarker([d.lat, d.lng])));
         mapInstance.fitBounds(group.getBounds(), { padding: [50, 50] });
      }
    }

    function openModal(d) {
      currentDevice = d;
      const modal = document.getElementById('modal-overlay');
      const pred = calculatePrediction(d); 
      
      // Resetar gráficos
      document.getElementById('charts-container').style.display = 'none';

      document.getElementById('modal-title').innerHTML = `${d.id} <span class="badge ${d.status}" style="margin-left:10px; font-size:12px; vertical-align:middle;">${d.status.toUpperCase()}</span>`;
      document.getElementById('modal-loc').innerHTML = d.location;
      document.getElementById('modal-prob').textContent = pred.prob + '%';
      let color = pred.riskLevel === 'high' ? '#e74c3c' : (pred.riskLevel === 'medium' ? '#f1c40f' : '#2ecc71');
      document.getElementById('modal-prog').style.width = pred.prob + '%';
      document.getElementById('modal-prog').style.backgroundColor = color;
      document.getElementById('modal-prob').style.color = color;
      document.getElementById('modal-cause').textContent = pred.cause;
      document.getElementById('modal-cause').style.color = color;
      document.getElementById('modal-rec').textContent = pred.rec;
      document.getElementById('modal-cpu').textContent = d.cpu + '%';
      document.getElementById('modal-ram').textContent = d.ram + '%';
      document.getElementById('modal-temp').textContent = d.temp + '°C';
      document.getElementById('modal-disk').textContent = d.disk + '%';
      document.getElementById('modal-uptime').textContent = d.uptime + 'h';
      document.getElementById('modal-ping').textContent = d.ping + 'ms';

      modal.style.display = 'flex';
      lucide.createIcons();
    }

    // --- GRÁFICOS ---
    function initCharts(d) {
        if(!d) return;
        const days = ['D-6', 'D-5', 'D-4', 'D-3', 'D-2', 'Ontem', 'Hoje'];
        const generateTrend = (base, volatility, isUp) => {
           return days.map((_, i) => {
              let val = base + (Math.random() * volatility - (volatility/2));
              if(isUp) val += (i * 4); 
              return Math.max(0, Math.min(100, Math.round(val)));
           });
        };
        const isCrit = d.status === 'critico';
        renderSingleChart('chart-cpu-div', 'CPU', generateTrend(isCrit ? 60 : 30, 15, isCrit), '#00f2ff');
        renderSingleChart('chart-temp-div', 'Temp', generateTrend(isCrit ? 70 : 45, 5, isCrit), '#fdcb6e');
        renderSingleChart('chart-ram-div', 'RAM', generateTrend(d.ram, 5, false), '#a29bfe');
        renderSingleChart('chart-disk-div', 'Disco', generateTrend(d.disk, 2, false), '#ff7675');
    }

    function renderSingleChart(id, label, data, color) {
       if(chartInstances[id]) { chartInstances[id].destroy(); }
       const options = {
          chart: { type: 'area', height: 140, sparkline: { enabled: false }, toolbar: { show: false }, background: 'transparent' },
          stroke: { curve: 'smooth', width: 2 },
          fill: { opacity: 0.2, type: 'gradient' },
          dataLabels: { enabled: false },
          series: [{ name: label, data: data }],
          xaxis: { categories: ['D-6', 'D-5', 'D-4', 'D-3', 'D-2', 'Ontem', 'Hoje'], labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
          yaxis: { show: false },
          grid: { show: false },
          colors: [color],
          tooltip: { theme: 'dark' }
       };
       const el = document.querySelector("#" + id);
       if(el) {
          const chart = new ApexCharts(el, options);
          chart.render();
          chartInstances[id] = chart;
       }
    }

    // --- INIT ---
    window.onload = async () => {
      initMap();
      allDevices = await fetchDados();
      if (allDevices.length > 0) {
        renderMap(allDevices);
        renderList(allDevices);
        updateStats(allDevices);
        const group = L.featureGroup(allDevices.map(d => L.circleMarker([d.lat, d.lng])));
        mapInstance.fitBounds(group.getBounds(), { padding: [50, 50] });
      }
      document.getElementById('search-dooh').addEventListener('input', applyFilters);
      document.getElementById('filter-status').addEventListener('change', applyFilters);
      document.getElementById('btn-reset-map').addEventListener('click', () => {
        document.getElementById('search-dooh').value = '';
        document.getElementById('filter-status').value = 'todos';
        applyFilters();
        mapInstance.setView([-23.56, -46.65], 13);
      });
      document.getElementById('modal-overlay').addEventListener('click', (e) => {
        if(e.target.id === 'modal-overlay') window.closeModal();
      });
    };
  </script>
</body>
</html>